<!DOCTYPE html>
<html lang="bn" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" content="notranslate" />
    <meta name="theme-color" id="theme-color-meta" content="#1c1c1c" />
    <title>AS Study Dashboard v13.4 (Enhanced Date Selection)</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet" />

    <style>
        :root {
            --bg-main: #f8f7f2; --bg-card: #ffffff; --bg-header: rgba(248,247,242,0.9);
            --text-primary: #3b2b22; --text-secondary: #1f2937; --text-muted: #6b6b6b;
            --border-primary: #e6d7c9; --border-secondary: #f3ece6;
            --progress-track: #d1d5db; /* Tailwind gray-300 */
        }
        html[data-theme="dark"] {
            --bg-main: #1c1c1c; --bg-card: #2a2a2a; --bg-header: rgba(28, 28, 28, 0.85);
            --text-primary: #e5e7eb; --text-secondary: #f3f4f6; --text-muted: #9ca3af;
            --border-primary: #4b5563; --border-secondary: #374151;
            --progress-track: #4b5563; /* Tailwind gray-600 */
        }

        html, body { height: 100%; margin: 0; background: var(--bg-main); color: var(--text-primary); font-family: 'Noto Sans Bengali', sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; }
        .card { background: var(--bg-card); border-radius: 12px; padding: 18px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07); border: 1px solid var(--border-secondary); transition: padding 0.2s ease; }
        .progress-bar-container { background-color: var(--progress-track); border-radius: 9999px; overflow: hidden; height: 0.5rem; }
        .progress-bar { height: 100%; border-radius: 9999px; transition: width 0.4s ease-out; }

        .pb-gradient-mint { background: linear-gradient(90deg, #6ee7b7, #34d399); }
        .pb-gradient-sky { background: linear-gradient(90deg, #7dd3fc, #38bdf8); }
        .pb-gradient-peach { background: linear-gradient(90deg, #fb923c, #f97316); }
        .pb-gradient-lav { background: linear-gradient(90deg, #c4b5fd, #a78bfa); }
        .pb-gradient-amber { background: linear-gradient(90deg, #fcd34d, #fbbf24); }
        .pb-gradient-cyan { background: linear-gradient(90deg, #67e8f9, #22d3ee); }
        .pb-gradient-rose { background: linear-gradient(90deg, #fb7185, #f43f5e); }
        
        #countdown-card { background: linear-gradient(135deg, #d90429, #ef233c); box-shadow: 0 10px 25px rgba(217, 4, 41, 0.25); }
        .countdown-num { font-weight:800; font-size:24px; } .countdown-label { font-size:12px; opacity:0.95; }
        .subject-progress-svg circle { transition: stroke-dashoffset 0.4s ease-out; }
        .subject-progress-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 12px; border: 2px solid transparent; transition: background 0.2s, border-color 0.2s; }
        .subject-progress-btn.active { border-color: var(--text-primary); background: var(--bg-main); box-shadow: 0 0 0 2px var(--text-primary); }

        .task-status-btn { --fill: 0%; position: relative; display:inline-flex; align-items:center; justify-content:center; width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--border-secondary); background: transparent; cursor: pointer; overflow: hidden; z-index: 1; transition: transform .08s ease; color: var(--text-secondary); font-size: 10px; font-weight: 600; }
        .task-status-btn::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: var(--fill, 0%); background: linear-gradient(90deg, #7dd3fc, #38bdf8); z-index: -1; transition: width .2s ease-out; }
        .task-status-btn:hover { transform: translateY(-2px); }
        .task-status-btn.wont { background: #ef4444; border-color: #991b1b; color: #fff !important; }
        .task-status-btn.done > span > svg { stroke: black; }
        html[data-theme='dark'] .task-status-btn.done > span > svg { stroke: black; }

        .note-btn { background: var(--bg-main); color: var(--text-muted); border: 1px solid var(--border-primary); border-radius: 6px; padding: 4px; cursor: pointer; transition: all 0.2s; opacity: 0.8; line-height: 1; }
        .note-btn:hover { opacity: 1; transform: scale(1.05); border-color: var(--text-muted); color: var(--text-primary); }
        .note-btn.has-note { opacity: 1; background: var(--text-primary); color: var(--bg-card); border-color: var(--text-primary); }
        html[data-theme="dark"] .note-btn.has-note { background: var(--text-primary); color: var(--bg-main); }

        .info-btn { font-family: sans-serif; font-weight: bold; font-size: 14px; cursor: pointer; color: var(--text-muted); border: 1px solid var(--border-primary); border-radius: 50%; width: 22px; height: 22px; display: inline-flex; justify-content: center; align-items: center; transition: all 0.2s; } .info-btn:hover { background: var(--bg-main); transform: scale(1.1); }
        #info-modal-overlay, #note-modal-overlay, #sync-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #info-modal-overlay.visible, #note-modal-overlay.visible, #sync-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        #info-modal-content, #note-modal-content, #sync-modal-content { background: var(--bg-card); padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; max-height: 80vh; overflow-y: auto; }
        #info-modal-overlay.visible #info-modal-content, #note-modal-overlay.visible #note-modal-content, #sync-modal-overlay.visible #sync-modal-content { transform: scale(1); }
        #info-modal-content ul { list-style-type: disc; padding-left: 20px; }
        #note-textarea { width: 100%; height: 150px; background: var(--bg-main); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 10px; margin-bottom: 15px; }
        #sync-queue-list li { font-size: 12px; padding: 4px 0; border-bottom: 1px solid var(--border-secondary); }

        .status-indicator { font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px; user-select: none; }
        .status-indicator.online { background-color: #166534; color: #dcfce7; } .status-indicator.offline { background-color: #991b1b; color: #fee2e2; }

        body.desktop-view { min-width: 1280px; }
        body:not(.desktop-view) .main-grid { grid-template-columns: 1fr; }
        body:not(.desktop-view) .right-column { grid-row-start: 1; }
        body:not(.desktop-view) .card { padding: 14px; width: 100%; box-sizing: border-box; }
        body.desktop-view .card { padding: 20px; }
        body:not(.desktop-view) h1 { font-size: 1.125rem; }
        body:not(.desktop-view) h2 { font-size: 1rem; }
        body:not(.desktop-view) #subject-selector { flex-wrap: wrap; gap: 8px; }
        body:not(.desktop-view) .subject-progress-svg { width: 56px; height: 56px; }
        body.desktop-view .subject-progress-svg { width: 64px; height: 64px; }
        body:not(.desktop-view) .countdown-num { font-size: 20px; }
        body:not(.desktop-view) .countdown-label { font-size: 11px; }
        body:not(.desktop-view) #countdown-card { padding: 16px; }
        body:not(.desktop-view) #header h1 { font-size: 1rem; }
        body.desktop-view #header h1 { font-size: 1.25rem; }
        body.desktop-view #selected-subject-main-progress,
        body.desktop-view #selected-subject-qb-progress { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        #syllabus-content table td, #syllabus-content table th { white-space: nowrap; }
        
        /* Goal Tracker Styles */
        .goal-tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; color: var(--text-muted); font-weight: 500;}
        .goal-tab.active { color: var(--text-primary); border-bottom-color: var(--text-primary); font-weight: 700; }
        .goal-list-item { display: flex; align-items: center; gap: 12px; padding: 8px 4px; border-bottom: 1px solid var(--border-secondary); }
        .goal-list-item:last-child { border-bottom: none; }
        .goal-tick-btn { flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border-primary); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .goal-list-item.completed .goal-tick-btn { background-color: var(--text-primary); border-color: var(--text-primary); }
        .goal-list-item.completed .goal-title { text-decoration: line-through; color: var(--text-muted); }
        .goal-title { flex-grow: 1; font-weight: 500; }
        .goal-action-btn { color: var(--text-muted); opacity: 0.5; transition: all 0.2s; }
        .goal-action-btn:hover { opacity: 1; color: var(--text-primary); }
        .goal-delete-btn:hover { color: #ef4444; }
        .goal-add-input { background: var(--bg-main); border: 1px solid var(--border-primary); border-radius: 8px; padding: 8px 12px; }
        .goal-date-editor { position: absolute; z-index: 10; }
        #week-selector-label { cursor: pointer; }

    </style>
</head>
<body class="text-sm">
    <div id="offline-banner" style="display:none;" class="bg-red-600 text-white p-2 text-center fixed top-0 w-full z-50">
        ‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶°‡ßá ‡¶Ü‡¶õ‡ßá‡¶®‡•§ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ü‡¶∏‡¶≤‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§
    </div>

    <header id="header" class="sticky top-0 z-30 w-full bg-header border-b border-primary backdrop-blur-sm">
        <div class="container max-w-screen-xl mx-auto flex justify-between items-center py-2 px-4">
            <h1 class="text-xl font-bold">AS Study Dashboard</h1>
            <div class="flex items-center gap-3">
                 <button id="export-json-btn" class="text-xs px-2 py-1 border border-primary rounded-md">Export JSON</button>
                 <button id="export-csv-btn" class="text-xs px-2 py-1 border border-primary rounded-md">Export CSV</button>
                <button id="view-toggle-btn" class="text-xs px-2 py-1 border border-primary rounded-md">Toggle View</button>
                <div id="connection-status" class="status-indicator">...</div>
                <button id="sync-queue-btn" class="relative text-xs px-2 py-1 border border-primary rounded-md">
                    Queue <span id="sync-queue-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center" style="display: none;">0</span>
                </button>
                <button id="theme-toggle-btn" title="Change theme">üåô</button>
            </div>
        </div>
    </header>

    <main id="app-container" class="container max-w-screen-xl mx-auto py-4 px-4">
        <div id="main-content-grid" class="main-grid grid grid-cols-3 gap-5" style="display: none;">
            <div class="left-column col-span-2 flex flex-col gap-5">
                <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® <span id="subject-choice-info-btn"></span></h2><div id="subject-selector" class="flex justify-around">Loading...</div></div>
                <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø <span id="main-progress-info-btn"></span></h2><div id="selected-subject-main-progress" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">Loading...</div></div>
                <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø <span id="exam-progress-info-btn"></span></h2><div id="selected-subject-exam-progress">Loading...</div></div>
                <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø <span id="qb-progress-info-btn"></span></h2><div id="selected-subject-qb-progress" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">Loading...</div></div>
                <section id="syllabus-shell" class="card"><h2 class="text-base font-bold mb-3">‡¶∏‡¶ø‡¶≤‡ßá‡¶¨‡¶æ‡¶∏ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h2><div id="syllabus-content">Loading...</div></section>
            </div>

            <div class="right-column col-span-1 grid grid-rows-[min-content,auto] gap-5">
                <div id="countdown-card" class="card text-white p-5">
                    <h2 class="text-lg font-bold mb-4 text-center flex justify-between items-center"><span>Final Countdown</span><span id="countdown-info-btn"></span></h2>
                    <div id="countdown" class="flex justify-around">Loading...</div>
                </div>
                <div class="flex flex-col gap-5">
                    <div class="card">
                        <h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶ì ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø <span id="global-summary-info-btn"></span></h2>
                        <div id="overall-progress-container" class="mb-4">Loading Progress...</div>
                        <div id="streak-container" class="mb-4"></div>
                        <div id="global-summary-container" class="flex flex-col gap-3">Loading Summaries...</div>
                    </div>
                    <!-- New Goal Tracker Card -->
                    <div id="goal-tracker-card" class="card">
                        <!-- Content will be rendered by JS -->
                    </div>
                </div>
            </div>
        </div>
        <div id="loading-indicator" class="text-center py-10">Initializing Dashboard...</div>
    </main>

    <div id="info-modal-overlay" role="dialog" aria-modal="true"><div id="info-modal-content"><h3 id="info-modal-title" class="font-bold text-lg mb-2"></h3><p id="info-modal-desc" class="text-muted mb-3 text-sm"></p><div class="mb-2 font-semibold text-sm">‡¶ó‡¶£‡¶®‡¶æ‡¶ï‡ßÉ‡¶§ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ:</div><ul id="info-modal-items" class="text-sm"></ul><button id="info-modal-close" class="mt-4 px-4 py-2 bg-rose-600 text-white rounded-lg w-full">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button></div></div>
    <div id="note-modal-overlay" role="dialog" aria-modal="true"><div id="note-modal-content"><h3 id="note-modal-title" class="font-bold text-lg mb-3">‡¶®‡ßã‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h3><textarea id="note-textarea"></textarea><div class="flex justify-between gap-2 mt-4"><button id="note-modal-undo" class="px-3 py-2 text-sm bg-gray-300 text-black rounded-lg">‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶´‡ßá‡¶∞‡¶æ‡¶®</button><button id="note-modal-clear" class="px-3 py-2 text-sm bg-yellow-500 text-black rounded-lg">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button><div class="flex-grow"></div><button id="note-modal-cancel" class="px-4 py-2 text-sm bg-gray-500 text-white rounded-lg">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button><button id="note-modal-save" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£</button></div></div></div>
    <div id="sync-modal-overlay" role="dialog" aria-modal="true"><div id="sync-modal-content"><h3 class="font-bold text-lg mb-3">‡¶Ö‡¶Æ‡ßÄ‡¶Æ‡¶æ‡¶Ç‡¶∏‡¶ø‡¶§ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï (<span id="sync-modal-count">0</span>)</h3><ul id="sync-queue-list" class="mb-4 max-h-60 overflow-y-auto"><li>‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶Æ‡ßÄ‡¶Æ‡¶æ‡¶Ç‡¶∏‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶®‡ßá‡¶á‡•§</li></ul><div class="flex justify-between gap-2 mt-4"><button id="sync-modal-clear" class="px-4 py-2 text-sm bg-red-600 text-white rounded-lg">‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡ßü ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button><button id="sync-modal-now" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg">‡¶è‡¶ñ‡¶® ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</button><button id="sync-modal-close" class="px-4 py-2 text-sm bg-gray-500 text-white rounded-lg">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button></div></div></div>

    <div id="toast-container" class="fixed right-4 bottom-5 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Top-level Config & Firebase Setup ---
        const FIRESTORE_USER_ID = 'as19'; // Change 'as19' to your user ID if needed.

        const firebaseConfig = {"apiKey":"AIzaSyDTLhIkrW9qk6KPT_gTDibIiJeVwWYTowk","authDomain":"my-study-dashboard.firebaseapp.com","projectId":"my-study-dashboard","storageBucket":"my-study-dashboard.appspot.com","messagingSenderId":"66307909031","appId":"1:66307909031:web:9e724a43c8c11a0ef80282"};
        let app, db, userDocRef;
        try { 
            app = initializeApp(firebaseConfig); 
            db = getFirestore(app); 
            userDocRef = doc(db, "users", FIRESTORE_USER_ID);
        } catch (e) { console.error("Firebase initialization failed:", e); }
        
        const DB_NAME = 'AdnanStudyDashboardDB_v1'; const DB_VERSION = 1; let idb;
        function openDB() { return new Promise((resolve, reject) => { try { const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = (e) => reject("Error opening DB: " + e.target.errorCode); request.onsuccess = (e) => { idb = e.target.result; resolve(idb); }; request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains('userData')) db.createObjectStore('userData', { keyPath: 'id' }); if (!db.objectStoreNames.contains('pendingWrites')) db.createObjectStore('pendingWrites', { keyPath: 'key' }); }; } catch(e) { reject(e); } }); }
        async function getFromDB(storeName, key) { if (!idb) return null; return new Promise((resolve) => { try { const tx = idb.transaction(storeName, 'readonly'); const store = tx.objectStore(storeName); const req = store.get(key); req.onsuccess = () => resolve(req.result); tx.onerror = () => resolve(null); } catch (e) { console.error(`IndexedDB get error (${storeName}, ${key}):`, e); resolve(null); } }); }
        async function getAllFromDB(storeName) { if (!idb) return []; return new Promise((resolve) => { try { const tx = idb.transaction(storeName, 'readonly'); const store = tx.objectStore(storeName); const req = store.getAll(); req.onsuccess = () => resolve(req.result); tx.onerror = () => resolve([]); } catch(e) { console.error(`IndexedDB getAll error (${storeName}):`, e); resolve([]); } }); }
        async function writeToDB(storeName, data) { if (!idb) return; return new Promise((resolve, reject) => { try { const tx = idb.transaction(storeName, 'readwrite'); tx.oncomplete = () => resolve(); tx.onerror = (e) => { if (e.target.error?.name === 'QuotaExceededError') { reject(new Error('QuotaExceededError')); } else { reject(tx.error); } }; const store = tx.objectStore(storeName); store.put(data); } catch (e) { reject(e); } }); }
        async function clearDBStore(storeName) { if (!idb) return; return new Promise((resolve, reject) => { try { const tx = idb.transaction(storeName, 'readwrite'); tx.oncomplete = () => resolve(); tx.onerror = (e) => reject(tx.error); const store = tx.objectStore(storeName); store.clear(); } catch(e) { reject(e); } }); }

        // --- App State & Data ---
        const state = { userData: {}, activeSubject: 'biology', syllabusOpenState: {}, isInitialized: false, lastCompositeProgress: 0, activeGoalTab: 'today', historyViewState: { mode: 'last7days', selectedDate: null }, currentWeeklyViewDate: new Date().toISOString() };
        const syllabusData = { biology: { name: "‡¶ú‡ßÄ‡¶¨‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", chapters: [ { id: 1, name: "‡¶ï‡ßã‡¶∑ ‡¶ì ‡¶è‡¶∞ ‡¶ó‡¶†‡¶®", paper: 1 }, { id: 2, name: "‡¶ï‡ßã‡¶∑ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ú‡¶®", paper: 1 }, { id: 3, name: "‡¶ï‡ßã‡¶∑ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 1 }, { id: 4, name: "‡¶Ö‡¶£‡ßÅ‡¶ú‡ßÄ‡¶¨", paper: 1 }, { id: 5, name: "‡¶∂‡ßà‡¶¨‡¶æ‡¶≤ ‡¶ì ‡¶õ‡¶§‡ßç‡¶∞‡¶æ‡¶ï", paper: 1 }, { id: 6, name: "‡¶¨‡ßç‡¶∞‡¶æ‡¶Ø‡¶º‡ßã‡¶´‡¶æ‡¶á‡¶ü‡¶æ ‡¶ì ‡¶ü‡ßá‡¶∞‡¶ø‡¶°‡ßã‡¶´‡¶æ‡¶á‡¶ü‡¶æ", paper: 1 }, { id: 7, name: "‡¶®‡¶ó‡ßç‡¶®‡¶¨‡ßÄ‡¶ú‡¶ø ‡¶ì ‡¶Ü‡¶¨‡ßÉ‡¶§‡¶¨‡ßÄ‡¶ú‡¶ø ‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶", paper: 1 }, { id: 8, name: "‡¶ü‡¶ø‡¶∏‡ßç‡¶Ø‡ßÅ ‡¶ì ‡¶ü‡¶ø‡¶∏‡ßç‡¶Ø‡ßÅ‡¶§‡¶®‡ßç‡¶§‡ßç‡¶∞", paper: 1 }, { id: 9, name: "‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨", paper: 1 }, { id: 10, name: "‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶ ‡¶™‡ßç‡¶∞‡¶ú‡¶®‡¶®", paper: 1 }, { id: 11, name: "‡¶ú‡ßÄ‡¶¨ ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø", paper: 1 }, { id: 12, name: "‡¶ú‡ßÄ‡¶¨‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂, ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞ ‡¶ì ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£", paper: 1 }, { id: 13, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶¨‡ßà‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡ßç‡¶Ø ‡¶ì ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø‡¶¨‡¶ø‡¶®‡ßç‡¶Ø‡¶æ‡¶∏", paper: 2 }, { id: 14, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø (‡¶π‡¶æ‡¶á‡¶°‡ßç‡¶∞‡¶æ)", paper: 2 }, { id: 15, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø (‡¶ò‡¶æ‡¶∏‡¶´‡¶°‡¶º‡¶ø‡¶Ç)", paper: 2 }, { id: 16, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø (‡¶∞‡ßÅ‡¶á ‡¶Æ‡¶æ‡¶õ)", paper: 2 }, { id: 17, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶™‡¶∞‡¶ø‡¶™‡¶æ‡¶ï ‡¶ì ‡¶∂‡ßã‡¶∑‡¶£", paper: 2 }, { id: 18, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶∞‡¶ï‡ßç‡¶§ ‡¶ì ‡¶∏‡¶û‡ßç‡¶ö‡¶æ‡¶≤‡¶®", paper: 2 }, { id: 19, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ì ‡¶∂‡ßç‡¶¨‡¶∏‡¶®", paper: 2 }, { id: 20, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶¨‡¶∞‡ßç‡¶ú‡ßç‡¶Ø ‡¶ì ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∂‡¶®", paper: 2 }, { id: 21, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶ö‡¶≤‡¶® ‡¶ì ‡¶Ö‡¶ô‡ßç‡¶ó‡¶ö‡¶æ‡¶≤‡¶®‡¶æ", paper: 2 }, { id: 22, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶∏‡¶Æ‡¶®‡ßç‡¶¨‡¶Ø‡¶º ‡¶ì ‡¶®‡¶ø‡¶Ø‡¶º‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£", paper: 2 }, { id: 23, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶ú‡ßÄ‡¶¨‡¶®‡ßá‡¶∞ ‡¶ß‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶ø‡¶ï‡¶§‡¶æ", paper: 2 }, { id: 24, name: "‡¶Æ‡¶æ‡¶®‡¶¨‡¶¶‡ßá‡¶π‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∞‡¶ï‡ßç‡¶∑‡¶æ", paper: 2 }, { id: 25, name: "‡¶ú‡¶ø‡¶®‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨ ‡¶ì ‡¶¨‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®", paper: 2 }, { id: 26, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶Ü‡¶ö‡¶∞‡¶£", paper: 2 } ] }, chemistry: { name: "‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", chapters: [ { id: 1, name: "‡¶≤‡ßç‡¶Ø‡¶æ‡¶¨‡¶∞‡ßá‡¶ü‡¶∞‡¶ø‡¶∞ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞", paper: 1 }, { id: 2, name: "‡¶ó‡ßÅ‡¶£‡¶ó‡¶§ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 1 }, { id: 3, name: "‡¶Æ‡ßå‡¶≤‡ßá‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡¶¨‡ßÉ‡¶§‡ßç‡¶§ ‡¶ß‡¶∞‡ßç‡¶Æ ‡¶ì ‡¶∞‡¶æ‡¶∏‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶ß‡¶®", paper: 1 }, { id: 4, name: "‡¶∞‡¶æ‡¶∏‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®", paper: 1 }, { id: 5, name: "‡¶ï‡¶∞‡ßç‡¶Æ‡¶Æ‡ßÇ‡¶ñ‡ßÄ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 1 }, { id: 6, name: "‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 7, name: "‡¶ú‡ßà‡¶¨ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 8, name: "‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£‡¶ó‡¶§ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 9, name: "‡¶§‡¶°‡¶º‡¶ø‡ßé ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 10, name: "‡¶Ö‡¶∞‡ßç‡¶•‡¶®‡ßà‡¶§‡¶ø‡¶ï ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 } ] }, physics: { name: "‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", chapters: [ { id: 1, name: "‡¶≠‡ßå‡¶§ ‡¶ú‡¶ó‡¶§ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™", paper: 1 }, { id: 2, name: "‡¶≠‡ßá‡¶ï‡ßç‡¶ü‡¶∞", paper: 1 }, { id: 3, name: "‡¶ó‡¶§‡¶ø‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ", paper: 1 }, { id: 4, name: "‡¶®‡¶ø‡¶â‡¶ü‡¶®‡¶ø‡¶Ø‡¶º‡¶æ‡¶® ‡¶¨‡¶≤‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ", paper: 1 }, { id: 5, name: "‡¶ï‡¶æ‡¶ú, ‡¶∂‡¶ï‡ßç‡¶§‡¶ø ‡¶ì ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ", paper: 1 }, { id: 6, name: "‡¶Æ‡¶π‡¶æ‡¶ï‡¶∞‡ßç‡¶∑ ‡¶ì ‡¶Ö‡¶≠‡¶ø‡¶ï‡¶∞‡ßç‡¶∑", paper: 1 }, { id: 7, name: "‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡ßá‡¶∞ ‡¶ó‡¶æ‡¶†‡¶®‡¶ø‡¶ï ‡¶ß‡¶∞‡ßç‡¶Æ", paper: 1 }, { id: 8, name: "‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶ó‡¶§‡¶ø", paper: 1 }, { id: 9, name: "‡¶§‡¶∞‡¶ô‡ßç‡¶ó", paper: 1 }, { id: 10, name: "‡¶Ü‡¶¶‡¶∞‡ßç‡¶∂ ‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏ ‡¶ì ‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ó‡¶§‡¶ø‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨", paper: 1 }, { id: 11, name: "‡¶§‡¶æ‡¶™‡¶ó‡¶§‡¶ø‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ", paper: 2 }, { id: 12, name: "‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶§‡¶°‡¶º‡¶ø‡ßé", paper: 2 }, { id: 13, name: "‡¶ö‡¶≤ ‡¶§‡¶°‡¶º‡¶ø‡ßé", paper: 2 }, { id: 14, name: "‡¶§‡¶°‡¶º‡¶ø‡ßé ‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶π‡ßá‡¶∞ ‡¶ö‡ßå‡¶Æ‡ßç‡¶¨‡¶ï ‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ì ‡¶ö‡ßÅ‡¶Æ‡ßç‡¶¨‡¶ï‡¶§‡ßç‡¶¨", paper: 2 }, { id: 15, name: "‡¶§‡¶°‡¶º‡¶ø‡ßé ‡¶ö‡ßå‡¶Æ‡ßç‡¶¨‡¶ï ‡¶Ü‡¶¨‡ßá‡¶∂ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶π", paper: 2 }, { id: 16, name: "‡¶ú‡ßç‡¶Ø‡¶æ‡¶Æ‡¶ø‡¶§‡¶ø‡¶ï ‡¶Ü‡¶≤‡ßã‡¶ï‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", paper: 2 }, { id: 17, name: "‡¶≠‡ßå‡¶§ ‡¶Ü‡¶≤‡ßã‡¶ï‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ", paper: 2 }, { id: 18, name: "‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡ßÇ‡¶ö‡¶®‡¶æ", paper: 2 }, { id: 19, name: "‡¶™‡¶∞‡¶Æ‡¶æ‡¶£‡ßÅ‡¶∞ ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶â‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", paper: 2 }, { id: 20, name: "‡¶∏‡ßá‡¶Æ‡¶ø‡¶ï‡¶®‡ßç‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡¶∞ ‡¶ì ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡¶∏", paper: 2 }, { id: 21, name: "‡¶ú‡ßç‡¶Ø‡ßã‡¶§‡¶ø‡¶∞‡ßç‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", paper: 2 } ] } };
        const trackableItems = ["‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á", "Class", "Rev Class", "Meditrics", "MQB (Unmesh)", "Retina QB", "Secret Files Exam", "Daily Exam", "Weekly Exam", "Campus Exam", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ßß", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ß®"];
        const mainStudyItems = ["‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á", "Class", "Meditrics"]; const revisionItems = ["‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ßß", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ß®", "Rev Class"]; const examItems = ["Secret Files Exam", "Daily Exam", "Weekly Exam", "Campus Exam"]; const qbItems = ["MQB (Unmesh)", "Retina QB"];
        const TARGET_DATE_STRING = '2025-12-12';

        // --- Calculation Logic ---
        const getRawPercentForStatus = (status) => (status >= 0 && status <= 5) ? status * 20 : 0;
        const normalizeRawTo100 = (raw) => raw <= 0 ? 0 : Math.min(100, (raw / 80) * 100);
        function calculateProgress(subjectKey, itemsToCount) { let currentItems = [...itemsToCount]; if (subjectKey === 'physics') currentItems = currentItems.filter(item => item !== '‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á'); const subjectData = syllabusData[subjectKey]; if (!subjectData || !subjectData.chapters) return { overall: 0, paper1: 0, paper2: 0 }; const mulBoiIndex = trackableItems.indexOf("‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á"); const meditricsIndex = trackableItems.indexOf("Meditrics"); const useMaxLogic = currentItems.includes("‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á") && currentItems.includes("Meditrics"); let itemIndices = currentItems.map(item => trackableItems.indexOf(item)).filter(i => i >= 0); let p1Sum = 0, p1Count = 0, p2Sum = 0, p2Count = 0; subjectData.chapters.forEach(ch => { let rawSum = 0; let itemsForAvg = itemIndices.length; if (useMaxLogic) { const nonSpecial = itemIndices.filter(i => i !== mulBoiIndex && i !== meditricsIndex); nonSpecial.forEach(i => { rawSum += getRawPercentForStatus(state.userData?.[`s_${subjectKey}_${ch.id}_${i}`] ?? 0); }); const mulBoiStatus = getRawPercentForStatus(state.userData?.[`s_${subjectKey}_${ch.id}_${mulBoiIndex}`] ?? 0); const medStatus = getRawPercentForStatus(state.userData?.[`s_${subjectKey}_${ch.id}_${meditricsIndex}`] ?? 0); rawSum += Math.max(mulBoiStatus, medStatus); itemsForAvg = nonSpecial.length + 1; } else { itemIndices.forEach(i => { rawSum += getRawPercentForStatus(state.userData?.[`s_${subjectKey}_${ch.id}_${i}`] ?? 0); }); } const normalized = normalizeRawTo100(itemsForAvg > 0 ? rawSum / itemsForAvg : 0); if (ch.paper === 1) { p1Sum += normalized; p1Count++; } else { p2Sum += normalized; p2Count++; } }); const paper1 = p1Count > 0 ? p1Sum / p1Count : 0; const paper2 = p2Count > 0 ? p2Sum / p2Count : 0; const overall = (p1Count + p2Count > 0) ? (p1Sum + p2Sum) / (p1Count + p2Count) : 0; return { overall, paper1, paper2 }; }
        const calculateComposite = () => { const subjects = Object.keys(syllabusData); if(!subjects.length) return { mainAvg: 0, revAvg: 0, examAvg: 0, qbAvg: 0, composite: 0 }; const mainAvg = calculateGlobalAverage(s => calculateProgress(s, mainStudyItems)).overall; const revAvg = calculateGlobalAverage(s => calculateProgress(s, revisionItems)).overall; const examAvg = calculateGlobalAverage(s => calculateProgress(s, examItems)).overall; const qbAvg = calculateGlobalAverage(s => calculateProgress(s, qbItems)).overall; return { mainAvg, revAvg, examAvg, qbAvg, composite: (mainAvg + revAvg + examAvg + qbAvg) / 4 }; };
        const calculateGlobalAverage = (fn) => { const subjects = Object.keys(syllabusData); let total = 0; subjects.forEach(key => { total += fn(key).overall; }); return { overall: total / (subjects.length || 1) }; };
        const calculateStudyStreak = () => { const timestamps = Object.keys(state.userData).filter(k => k.startsWith('timestamp_s_')).map(k => state.userData[k]).filter(Boolean); if (timestamps.length === 0) return 0; const uniqueDays = [...new Set(timestamps.map(d => { try { const dt = new Date(d); return dt.toISOString().slice(0,10); } catch(e) { return null; } }))].filter(Boolean).sort().reverse(); const todayISO = (new Date()).toISOString().slice(0,10); let streak = 0; let cursor = new Date(todayISO); let cursorISO = todayISO; let firstDayFound = uniqueDays.includes(todayISO); if(firstDayFound) { for (const day of uniqueDays) { if (day === cursorISO) { streak++; cursor.setUTCDate(cursor.getUTCDate() - 1); cursorISO = cursor.toISOString().slice(0,10); } else if (day < cursorISO) { break; } } } return streak; };

        // --- UI Rendering Functions ---
        const createInfoButton = (data) => { const btn = document.createElement('button'); btn.className = 'info-btn'; btn.textContent = '?'; Object.entries(data).forEach(([k, v]) => { try { btn.dataset[k] = Array.isArray(v) ? JSON.stringify(v) : v; } catch(e){ console.warn(`Failed to set dataset for ${k}`, e); }}); return btn; };
        const createProgressBar = (p, color) => `<div class="w-full progress-bar-container"><div class="progress-bar pb-gradient-${color} h-2" style="width: ${p.toFixed(1)}%"></div></div>`;
        const createSingleProgressBarHTML = (value, title, color) => `<div class="border border-secondary rounded-md p-2"> <div class="text-xs flex justify-between items-center mb-1"><span>${title}</span> <strong class="font-bold">${value.toFixed(1)}%</strong></div> ${createProgressBar(value, color)}</div>`;
        const createBreakdownProgressBar = (data, title, colors=['sky','peach','lav']) => `<div class="flex flex-col gap-2"> <div class="font-bold text-sm">${title}</div> <div class="grid grid-cols-[60px,1fr,45px] items-center gap-2 text-xs"> <span>‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞</span>${createProgressBar(data.paper1, colors[0])}<span class="text-right font-medium">${data.paper1.toFixed(1)}%</span> <span>‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞</span>${createProgressBar(data.paper2, colors[1])}<span class="text-right font-medium">${data.paper2.toFixed(1)}%</span> <span class="font-bold">‡¶Æ‡ßã‡¶ü</span>${createProgressBar(data.overall, colors[2])}<span class="text-right font-bold">${data.overall.toFixed(1)}%</span> </div></div>`;
        const createCircularProgressBar = (p, color) => `<svg class="subject-progress-svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" stroke="var(--progress-track)" stroke-width="5" fill="none" /><circle cx="32" cy="32" r="28" stroke="${color}" stroke-width="5" fill="none" stroke-dasharray="${2 * Math.PI * 28}" stroke-dashoffset="${(1 - (p/100)) * 2 * Math.PI * 28}" stroke-linecap="round" /></svg>`;
        function renderSubjectSelector() { const container = document.getElementById('subject-selector'); if(!container) return; const fragment = document.createDocumentFragment(); const colors = ['#34d399', '#f97316', '#38bdf8']; Object.keys(syllabusData).forEach((key, idx) => { const btn = document.createElement('div'); const isActive = state.activeSubject === key; const progress = calculateProgress(key, mainStudyItems); btn.className = `subject-progress-btn ${isActive ? 'active' : ''}`; btn.dataset.subject = key; btn.innerHTML = `<div class="relative">${createCircularProgressBar(progress.overall, colors[idx % colors.length])}<div class="absolute inset-0 flex items-center justify-center font-bold text-primary">${progress.overall.toFixed(0)}%</div></div><span class="font-semibold text-sm">${syllabusData[key].name}</span>`; btn.onclick = () => { if (state.activeSubject !== key) { state.activeSubject = key; renderAll(); }}; fragment.appendChild(btn); }); container.innerHTML = ''; container.appendChild(fragment); }
        function renderProgressCards() {
            const subject = state.activeSubject;
            const mainProgEl = document.getElementById('selected-subject-main-progress'); if(mainProgEl) mainProgEl.innerHTML = createBreakdownProgressBar(calculateProgress(subject, mainStudyItems), '‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á ‡¶ì ‡¶≤‡ßá‡¶ï‡¶ö‡¶æ‡¶∞') + createBreakdownProgressBar(calculateProgress(subject, revisionItems), '‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶®', ['rose', 'amber', 'lav']);
            const examProgEl = document.getElementById('selected-subject-exam-progress'); if(examProgEl) examProgEl.innerHTML = createBreakdownProgressBar(calculateProgress(subject, examItems), '‡¶∏‡¶ï‡¶≤ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ', ['peach', 'cyan', 'mint']);
            const qbProgEl = document.getElementById('selected-subject-qb-progress'); if(qbProgEl) qbProgEl.innerHTML = createBreakdownProgressBar(calculateProgress(subject, ["MQB (Unmesh)"]), 'MQB (Unmesh)', ['amber', 'amber', 'amber']) + createBreakdownProgressBar(calculateProgress(subject, ["Retina QB"]), 'Retina QB', ['cyan', 'cyan', 'cyan']);
            const composite = calculateComposite();
            const totalEl = document.getElementById('overall-progress-container');
            if(totalEl) { totalEl.innerHTML = `<div class="border border-secondary rounded p-2 mb-3"><div class="font-bold text-sm mb-1">‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø</div><div class="grid grid-cols-[1fr,45px] items-center gap-2 text-xs">${createProgressBar(composite.composite, 'lav')}<span class="text-right font-bold">${composite.composite.toFixed(1)}%</span></div></div>`; }
            const globalSummary = document.getElementById('global-summary-container');
            if(globalSummary) { globalSummary.innerHTML = createSingleProgressBarHTML(composite.mainAvg, "‡¶Æ‡ßÇ‡¶≤ ‡¶™‡¶æ‡¶†", "mint") + createSingleProgressBarHTML(composite.revAvg, "‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶®", "sky") + createSingleProgressBarHTML(composite.examAvg, "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ", "peach") + createSingleProgressBarHTML(composite.qbAvg, "‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï", "amber"); }
        }
        function renderSyllabusContent() { const container = document.getElementById('syllabus-content'); if(!container) return; const fragment = document.createDocumentFragment(); const subjectKey = state.activeSubject; const chaptersByPaper = syllabusData[subjectKey]?.chapters?.reduce((acc, chap) => { (acc[chap.paper] = acc[chap.paper] || []).push(chap); return acc; }, {}); if(!chaptersByPaper) { container.innerHTML = 'No chapters found.'; return; } const noteIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>`; const tickIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`; Object.entries(chaptersByPaper).forEach(([paper, chapters]) => { const details = document.createElement('details'); details.dataset.paper = paper; details.open = state.syllabusOpenState[`${subjectKey}-${paper}`] !== false; const paperProgress = calculateProgress(subjectKey, mainStudyItems); const currentPaperProgress = (paper == 1) ? paperProgress.paper1 : paperProgress.paper2; details.innerHTML = `<summary class="flex justify-between items-center p-3 border border-secondary rounded-lg mb-2 cursor-pointer transition-all hover:bg-main"><div class="font-bold flex items-center">${paper}‡¶Æ ‡¶™‡¶§‡ßç‡¶∞ <span class="text-sm font-normal text-muted ml-2" data-paper-percent>(${currentPaperProgress.toFixed(1)}%)</span> <span class="ml-2" data-info-btn-id="paper-${paper}-info-btn"></span></div><div class="w-1/3" data-paper-progress-bar="${paper}">${createProgressBar(currentPaperProgress, paper == 1 ? 'sky' : 'peach')}</div></summary>`; const tableWrapper = document.createElement('div'); tableWrapper.className = 'overflow-x-auto'; const table = document.createElement('table'); table.innerHTML = `<thead><tr><th class="w-1/4">‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü</th>${trackableItems.map(h => `<th class="text-center">${h}</th>`).join('')}</tr></thead>`; const tbody = document.createElement('tbody'); chapters.forEach(chapter => { const tr = document.createElement('tr'); let cells = `<td class="font-medium">${chapter.name}</td>`; trackableItems.forEach((item, i) => { const key = `s_${subjectKey}_${chapter.id}_${i}`; const status = Number(state.userData?.[key] ?? 0); const noteKey = `note_${key}`; const hasNote = !!state.userData?.[noteKey]; 
        const fillValue = (status <= 4) ? status * 20 : 100; // 80% then 100%
        const isDone = status === 5; 
        const isWont = status === 6; 
        const statusText = isWont ? '‚úñ' : (isDone ? tickIconSVG : `${status * 20}%`); 
        cells += `<td class="text-center"><button class="task-status-btn ${isWont ? 'wont' : ''} ${isDone ? 'done' : ''}" data-key="${key}" style="--fill:${fillValue}%"><span class="relative z-10">${statusText}</span></button><button class="note-btn ${hasNote ? 'has-note' : ''} ml-2" data-key="${noteKey}" data-title="${chapter.name} - ${item}">${noteIconSVG}</button></td>`; }); tr.innerHTML = cells; tbody.appendChild(tr); }); table.appendChild(tbody); tableWrapper.appendChild(table); details.appendChild(tableWrapper); fragment.appendChild(details); }); container.innerHTML = ''; container.appendChild(fragment); setupInfoButtons(); }
        function renderStudyStreak() { const container = document.getElementById('streak-container'); if (!container) return; const streak = calculateStudyStreak(); if (streak > 0) { container.innerHTML = `<div class="text-sm flex items-center justify-center gap-2 border border-secondary rounded-md p-2"> <span class="text-lg">üî•</span> <span class="font-bold">‡¶Ü‡¶™‡¶®‡¶ø ${streak}-‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶°‡¶ø ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï‡ßá ‡¶Ü‡¶õ‡ßá‡¶®!</span> <span class="text-lg">üî•</span> </div>`; } else { container.innerHTML = ''; } }
        
        // --- Goal Tracker ---
        function getWeekDateRange(refDateString) {
            const refDate = new Date(refDateString);
            const dayOfWeek = refDate.getDay(); 
            const first = refDate.getDate() - dayOfWeek;
            const last = first + 6;

            const sunday = new Date(refDate.setDate(first));
            const saturday = new Date(refDate.setDate(last));
             sunday.setHours(0,0,0,0);
            saturday.setHours(23,59,59,999);

            return {
                start: sunday,
                end: saturday,
                startFormatted: sunday.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long'}),
                endFormatted: saturday.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long'})
            };
        }

        function renderGoalsCard() {
            const container = document.getElementById('goal-tracker-card');
            if (!container) return;

            const goals = state.userData.goals || { today: [], weekly: [] };
            const todayProgress = goals.today.length > 0 ? (goals.today.filter(g => g.completed).length / goals.today.length) * 100 : 0;
            const weekRange = getWeekDateRange(state.currentWeeklyViewDate);
            const weeklyGoalsForCurrentView = goals.weekly.filter(g => {
                if (!g.dueDate) return false; 
                const goalDate = new Date(g.dueDate);
                return goalDate >= weekRange.start && goalDate <= weekRange.end;
            });

            const weeklyProgress = weeklyGoalsForCurrentView.length > 0 ? (weeklyGoalsForCurrentView.filter(g => g.completed).length / weeklyGoalsForCurrentView.length) * 100 : 0;
            const consolidatedProgress = (todayProgress + weeklyProgress) / 2;
            
            const tickSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4" style="color: var(--bg-card);"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>`;
            const calendarSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c0-.414.336-.75.75-.75h10.5a.75.75 0 01.75.75v1.25c0 .414-.336.75-.75.75H5.5a.75.75 0 01-.75-.75V7.5z" clip-rule="evenodd" /></svg>`;

            container.innerHTML = `
                <h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø <span id="goal-info-btn"></span></h2>
                <div class="mb-3">${createProgressBar(consolidatedProgress, 'mint')}</div>
                <div class="flex border-b border-secondary mb-3">
                    <button data-tab="today" class="goal-tab ${state.activeGoalTab === 'today' ? 'active' : ''}">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø</button>
                    <button data-tab="weekly" class="goal-tab ${state.activeGoalTab === 'weekly' ? 'active' : ''}">‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø</button>
                    <button data-tab="history" class="goal-tab ${state.activeGoalTab === 'history' ? 'active' : ''}">‡¶¨‡¶ø‡¶ó‡¶§ ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π</button>
                </div>
                
                <div id="goal-tab-content"></div>
            `;
            
            const contentContainer = container.querySelector('#goal-tab-content');
            
            if (state.activeGoalTab === 'history') {
                 const allGoals = [...(goals.today || []), ...(goals.weekly || [])];
                const uniqueGoals = Array.from(new Map(allGoals.map(item => [item.id, item])).values());

                let historyGoals;
                if (state.historyViewState.mode === 'specificDate' && state.historyViewState.selectedDate) {
                    historyGoals = uniqueGoals.filter(g => {
                        return g.completed && g.completedAt && g.completedAt.startsWith(state.historyViewState.selectedDate);
                    });
                } else { // last7days
                    historyGoals = uniqueGoals.filter(g => {
                        if (!g.completed || !g.completedAt) return false;
                        const completedDate = new Date(g.completedAt);
                        const sevenDaysAgo = new Date();
                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                        sevenDaysAgo.setHours(0,0,0,0);
                        return completedDate >= sevenDaysAgo;
                    });
                }

                contentContainer.innerHTML = `
                    <div class="flex items-center justify-between gap-2 mb-3 text-xs">
                       <div class="flex items-center gap-2">
                         <input type="date" id="history-date-picker" class="goal-add-input w-auto" value="${state.historyViewState.selectedDate || ''}">
                         <button id="view-specific-date-btn" class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-md">‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                       </div>
                       <button id="view-last-7-days-btn" class="px-2 py-1 ${state.historyViewState.mode === 'last7days' ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700'} rounded-md">‡¶ó‡¶§ ‡ß≠ ‡¶¶‡¶ø‡¶®</button>
                    </div>
                ` + (historyGoals.length === 0 
                    ? `<p class="text-center text-muted text-sm py-4">‡¶è‡¶á ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>`
                    : `<ul class="space-y-2 mb-4">${historyGoals.map(goal => `
                        <li class="goal-list-item completed">
                            <span class="goal-tick-btn">${tickSVG}</span>
                            <span class="goal-title">${goal.title}</span>
                             <span class="text-xs text-muted">${new Date(goal.completedAt).toLocaleDateString('bn-BD')}</span>
                        </li>`).join('')}</ul>`);
            } else {
                const goalsToShow = state.activeGoalTab === 'today' ? goals.today : weeklyGoalsForCurrentView;
                const progressToShow = state.activeGoalTab === 'today' ? todayProgress : weeklyProgress;
                
                let tabHeader = '';
                if(state.activeGoalTab === 'weekly') {
                     tabHeader = `<div class="text-xs text-center text-muted mb-2 font-semibold flex justify-center items-center gap-2">
                        <span>${weekRange.startFormatted} - ${weekRange.endFormatted}</span>
                        <label id="week-selector-label" class="cursor-pointer">${calendarSVG}</label>
                        <input type="date" id="week-selector-input" class="hidden absolute">
                    </div>`;
                }

                contentContainer.innerHTML = `
                    ${tabHeader}
                    <div class="mb-3">
                        <div class="text-xs flex justify-between items-center mb-1"><span>${state.activeGoalTab === 'today' ? '‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞' : '‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï'} ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø</span> <strong>${progressToShow.toFixed(0)}%</strong></div>
                        ${createProgressBar(progressToShow, 'sky')}
                    </div>
                    <ul id="goal-list" class="space-y-2 mb-4">
                        ${goalsToShow.length === 0 ? `<p class="text-center text-muted text-sm py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>` : ''}
                        ${goalsToShow.map(goal => `
                            <li class="goal-list-item ${goal.completed ? 'completed' : ''}" data-goal-id="${goal.id}">
                                <button class="goal-tick-btn">${goal.completed ? tickSVG : ''}</button>
                                <span class="goal-title">${goal.title}</span>
                                <div class="relative">
                                     <button class="goal-action-btn goal-date-btn">${calendarSVG}</button>
                                     <input type="date" class="goal-date-editor hidden absolute right-0 top-0" value="${goal.dueDate || ''}">
                                </div>
                                <button class="goal-action-btn goal-delete-btn" data-goal-id="${goal.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
                                </button>
                            </li>`).join('')}
                    </ul>
                    <form id="goal-add-form" class="flex items-center gap-2">
                        <input type="text" class="goal-add-input flex-grow" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
                        <input type="date" id="goal-due-date" class="goal-add-input w-auto">
                        <button type="submit" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-sm">‡¶Ø‡ßã‡¶ó</button>
                    </form>
                `;
            }
        }

        function setupInfoButtons() {
            const attach = (selector, data) => { try { const el = document.querySelector(selector); if(el) { el.innerHTML = ''; el.append(createInfoButton(data)); }} catch(e){ console.warn(`Failed attaching info btn to ${selector}`, e)} };
            attach('#subject-choice-info-btn', {modalTitle: "‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®", modalDesc: "‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡¶æ‡¶†‡ßá‡¶∞ ‡¶ó‡ßú ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", modalItems: mainStudyItems});
            attach('#main-progress-info-btn', {modalTitle: "‡¶Æ‡ßÇ‡¶≤ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶ó‡¶£‡¶®‡¶æ", modalDesc: "‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á ‡¶ì ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡ßá‡¶ï‡¶ö‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ó‡ßú ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡•§ ‡¶¨‡¶æ‡ßü‡ßã‡¶≤‡¶ú‡¶ø ‡¶ì ‡¶ï‡ßá‡¶Æ‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á ‡¶ì ‡¶Æ‡ßá‡¶°‡¶ø‡¶ü‡ßç‡¶∞‡¶ø‡¶ï‡ßç‡¶∏ ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö‡¶ü‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶´‡¶ø‡¶ú‡¶ø‡¶ï‡ßç‡¶∏‡ßá ‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á ‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡•§", modalItems: mainStudyItems.concat(revisionItems)});
            attach('#exam-progress-info-btn', {modalTitle: "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶ó‡¶£‡¶®‡¶æ", modalDesc: "‡¶∏‡¶ï‡¶≤ ‡¶ß‡¶∞‡¶£‡ßá‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ó‡ßú ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡•§", modalItems: examItems});
            attach('#qb-progress-info-btn', {modalTitle: "‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ó‡¶£‡¶®‡¶æ", modalDesc: "‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶ó‡ßú ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡•§", modalItems: qbItems});
            attach('#global-summary-info-btn', {modalTitle: "‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶ì Composite", modalDesc: "‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø (Composite): ‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ Main Study, Revision, Exams, ‡¶è‡¶¨‡¶Ç QB - ‡¶è‡¶á ‡¶ö‡¶æ‡¶∞‡¶ü‡¶ø ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡¶∞ ‡¶ó‡ßú‡•§", modalItems: ["Overall Progress", "Global Main Study", "Global Revision", "Global Exams", "Global Question Banks"]});
            attach('[data-info-btn-id="paper-1-info-btn"]', {modalTitle: "‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø", modalDesc: "‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", modalItems: mainStudyItems});
            attach('[data-info-btn-id="paper-2-info-btn"]', {modalTitle: "‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø", modalDesc: "‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", modalItems: mainStudyItems});
            attach('#countdown-info-btn', { modalTitle: "Countdown Target", modalDesc: `Counting down to: ${TARGET_DATE_STRING}`, modalItems: [] });
            attach('#goal-info-btn', { modalTitle: "‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø", modalDesc: "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßà‡¶®‡¶®‡ßç‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶æ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø‡¶ó‡ßÅ‡¶≤‡ßã '‡¶¨‡¶ø‡¶ó‡¶§ ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π' ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡•§", modalItems: ["‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "‡¶≠‡ßÅ‡¶≤ ‡¶π‡¶≤‡ßá undo ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó ‡¶∞‡ßü‡ßá‡¶õ‡ßá‡•§", "‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶á‡¶ï‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®‡•§"] });
        }

        // --- State Update & Sync Logic ---
        let updateTimeout; let noteModalOverlay, noteModalTitle, noteTextarea, syncModalOverlay;
        const debouncedUpdate = (key, value) => { clearTimeout(updateTimeout); updateTimeout = setTimeout(() => { updateState(key, value); checkMilestones(); }, 150); };
        async function updateState(key, value, debounce = false) {
            // Simplified for goals
            if (key === 'userData.goals') {
                state.userData.goals = value;
            } else {
                const dataKey = key.startsWith('userData.') ? key.substring(9) : null; 
                if (!dataKey) return;
                state.userData[dataKey] = value;
            }

            const updateAction = async () => {
                const writesToQueue = [];
                if (key === 'userData.goals') {
                    writesToQueue.push({ key: 'goals', value: value });
                } else {
                    const dataKey = key.substring(9);
                    writesToQueue.push({ key: dataKey, value: value });
                     if (dataKey.startsWith('s_')) { 
                        const timestampKey = `timestamp_${dataKey}`; 
                        state.userData[timestampKey] = new Date().toISOString(); 
                        writesToQueue.push({ key: timestampKey, value: state.userData[timestampKey] }); 
                    }
                }

                try { 
                    for (const item of writesToQueue) { await writeToDB('pendingWrites', item); } 
                    await writeToDB('userData', { id: 'main', value: state.userData }); 
                    document.getElementById('connection-status').textContent = 'Saved locally'; 
                    rerenderProgressBarsOnly(); 
                    await updateSyncQueueCount(); 
                    syncPendingWrites(); 
                } catch (e) { 
                    console.error("DB write failed:", e); 
                    if (e.message === 'QuotaExceededError') { showToast('‚ùå Local storage is full!', 'error'); } 
                    else { showToast('‚ùå Local save failed!', 'error'); } 
                }
            };

            if (debounce) {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(updateAction, 250);
            } else {
                await updateAction();
            }
        }

        function rerenderProgressBarsOnly() { try { renderSubjectSelector(); renderProgressCards(); renderStudyStreak(); renderGoalsCard(); const subjectKey = state.activeSubject; const paperProgress = calculateProgress(subjectKey, mainStudyItems); updatePaperSummaryProgress(1, paperProgress.paper1); updatePaperSummaryProgress(2, paperProgress.paper2); updateSyncQueueCount(); } catch (e) { console.error("Error updating visuals:", e); renderAll(); } }
        function updatePaperSummaryProgress(paperNum, progressValue) { const summaryEl = document.querySelector(`details[data-paper="${paperNum}"] > summary`); if (summaryEl) { const progressDiv = summaryEl.querySelector(`[data-paper-progress-bar="${paperNum}"]`); const percentSpan = summaryEl.querySelector('[data-paper-percent]'); const color = paperNum === 1 ? 'sky' : 'peach'; if (progressDiv) progressDiv.innerHTML = createProgressBar(progressValue, color); if (percentSpan) percentSpan.textContent = `(${progressValue.toFixed(1)}%)`; } }
        async function syncPendingWrites() {
            const syncStatusEl = document.getElementById('connection-status'); if (!db || !userDocRef) { syncStatusEl.textContent = 'Firebase Error'; syncStatusEl.className = 'status-indicator offline'; return; }
            if (!navigator.onLine) { syncStatusEl.textContent = 'Offline'; syncStatusEl.className = 'status-indicator offline'; return; }
            const pending = await getAllFromDB('pendingWrites'); await updateSyncQueueCount(pending.length);
            if (pending.length === 0) { const lastSynced = (await getFromDB('userData', 'setting_lastSynced'))?.value; syncStatusEl.textContent = lastSynced ? `Synced: ${lastSynced}` : 'Synced'; syncStatusEl.className = 'status-indicator online'; return; }
            syncStatusEl.textContent = `Syncing...`;
            try { const updates = {}; pending.forEach(item => { updates[item.key] = item.value }); await setDoc(userDocRef, updates, { merge: true }); await clearDBStore('pendingWrites'); const now = new Date().toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }); await writeToDB('userData', { id: 'setting_lastSynced', value: now }); syncStatusEl.textContent = `Synced: ${now}`; syncStatusEl.className = 'status-indicator online'; showToast('‚úÖ Sync Successful!', 'success'); await updateSyncQueueCount(0); } catch (error) { console.error("Sync error: ", error); syncStatusEl.textContent = 'Sync Failed'; syncStatusEl.className = 'status-indicator offline'; if (error.message === 'QuotaExceededError') { showToast('‚ùå Sync Failed: Storage full!', 'error'); } else { showToast(`‚ùå Sync Failed! ${error.code || error.message}`, 'error'); } }
        }
        function checkMilestones() { const newCompositeProgress = calculateComposite().composite; const milestones = [50, 75, 100]; milestones.forEach(ms => { if (state.lastCompositeProgress < ms && newCompositeProgress >= ms) { showToast(`üéâ‡¶Æ‡¶æ‡¶á‡¶≤‡¶´‡¶≤‡¶ï ‡¶Ö‡¶∞‡ßç‡¶ú‡¶ø‡¶§: ${ms}% ‡¶∏‡¶æ‡¶Æ‡¶ó‡ßç‡¶∞‡¶ø‡¶ï ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø!`, 'success'); } }); state.lastCompositeProgress = newCompositeProgress; }

        // --- Utility Functions ---
        function showToast(message, type = 'success', options = {}) { 
            const container = document.getElementById('toast-container');
            const t = document.createElement('div'); 
            t.className = `px-4 py-2 rounded-lg shadow-lg ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white transition-all duration-300 transform opacity-0 translate-y-5 flex items-center gap-4`; 
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            t.appendChild(messageSpan);
            
            if (options.actionText && options.action) {
                const actionBtn = document.createElement('button');
                actionBtn.textContent = options.actionText;
                actionBtn.className = 'font-bold underline';
                actionBtn.onclick = () => {
                    options.action();
                    t.remove();
                };
                t.appendChild(actionBtn);
            }

            container.appendChild(t); 
            setTimeout(() => t.classList.remove('opacity-0', 'translate-y-5'), 50); 
            
            if (!options.action) { // Auto-dismiss if no action
                setTimeout(() => { 
                    t.classList.add('opacity-0', 'translate-y-5'); 
                    t.addEventListener('transitionend', () => t.remove()); 
                }, options.duration || 4000); 
            }
        }
        let currentNoteKey = null; let initialNoteValue = '';
        function openNoteModal(key, title) { currentNoteKey = key; initialNoteValue = state.userData?.[key] ?? ''; if(noteModalTitle) noteModalTitle.textContent = `‡¶®‡ßã‡¶ü: ${title}`; if(noteTextarea) noteTextarea.value = initialNoteValue; noteModalOverlay?.classList.add('visible'); }
        function closeNoteModal() { noteModalOverlay?.classList.remove('visible'); currentNoteKey = null; initialNoteValue = ''; }
        function setupModalEventHandlers() {
            document.getElementById('note-modal-save')?.addEventListener('click', () => { if (currentNoteKey) { const newValue = noteTextarea.value; updateState(`userData.${currentNoteKey}`, newValue); const btn = document.querySelector(`.note-btn[data-key="${currentNoteKey}"]`); if(btn) btn.classList.toggle('has-note', !!newValue); } closeNoteModal(); });
            document.getElementById('note-modal-cancel')?.addEventListener('click', closeNoteModal);
            document.getElementById('note-modal-clear')?.addEventListener('click', () => { if(noteTextarea) noteTextarea.value = ''});
            document.getElementById('note-modal-undo')?.addEventListener('click', () => { if(noteTextarea) noteTextarea.value = initialNoteValue});
            noteModalOverlay?.addEventListener('click', e => { if (e.target === noteModalOverlay) closeNoteModal(); });
            document.getElementById('sync-queue-btn')?.addEventListener('click', openSyncQueueModal);
            document.getElementById('sync-modal-close')?.addEventListener('click', closeSyncQueueModal);
            document.getElementById('sync-modal-now')?.addEventListener('click', () => { syncPendingWrites(); closeSyncQueueModal(); });
            document.getElementById('sync-modal-clear')?.addEventListener('click', async () => { try { await clearDBStore('pendingWrites'); await updateSyncQueueCount(0); showToast('‚úÖ Local changes cleared!', 'success'); renderSyncQueuePanel(); } catch(e) { showToast('‚ùå Failed to clear changes!', 'error'); } });
            syncModalOverlay?.addEventListener('click', e => { if (e.target === syncModalOverlay) closeSyncQueueModal(); });
        }
        function openSyncQueueModal() { renderSyncQueuePanel(); syncModalOverlay?.classList.add('visible'); }
        function closeSyncQueueModal() { syncModalOverlay?.classList.remove('visible'); }
        function translateSyncKey(key) { if (key === 'studyGoal') return 'Study Goal'; if (key === 'goals') return 'Daily/Weekly Goals'; if (key.startsWith('note_')) { const parts = key.replace('note_s_', '').split('_'); const subject = syllabusData[parts[0]]?.name || parts[0]; const chapter = syllabusData[parts[0]]?.chapters?.find(c => c.id == parts[1])?.name || `Ch ${parts[1]}`; const item = trackableItems[parts[2]] || `Item ${parts[2]}`; return `Note: ${subject} - ${chapter} - ${item}`; } if (key.startsWith('s_')) { const parts = key.replace('s_', '').split('_'); const subject = syllabusData[parts[0]]?.name || parts[0]; const chapter = syllabusData[parts[0]]?.chapters?.find(c => c.id == parts[1])?.name || `Ch ${parts[1]}`; const item = trackableItems[parts[2]] || `Item ${parts[2]}`; return `Update: ${subject} - ${chapter} - ${item}`; } if (key.startsWith('timestamp_')) return `Timestamp for ${translateSyncKey(key.replace('timestamp_', ''))}`; return key; }
        async function renderSyncQueuePanel() { const listEl = document.getElementById('sync-queue-list'); const countEl = document.getElementById('sync-modal-count'); if (!listEl || !countEl) return; const pending = await getAllFromDB('pendingWrites'); countEl.textContent = pending.length; if (pending.length === 0) { listEl.innerHTML = '<li>No pending changes.</li>'; return; } listEl.innerHTML = ''; pending.forEach(item => { const li = document.createElement('li'); li.textContent = translateSyncKey(item.key); listEl.appendChild(li); }); }
        async function updateSyncQueueCount(count = null) { const badge = document.getElementById('sync-queue-count'); if (!badge) return; try { const currentCount = count ?? (await getAllFromDB('pendingWrites')).length; badge.textContent = currentCount; badge.style.display = currentCount > 0 ? 'flex' : 'none'; } catch(e){ console.error("Failed to update sync count", e); }}

        function setupEventHandlers() {
            const infoModalOverlay = document.getElementById('info-modal-overlay');
            const tickIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
            
            document.body.addEventListener('click', e => {
                const target = e.target;
                const targetBtn = target.closest('button');

                if (targetBtn) {
                    // --- Main Dashboard Actions ---
                    if (targetBtn.id === 'export-csv-btn') { exportDataToCSV(); return; }
                    if (targetBtn.id === 'export-json-btn') { exportDataToJSON(); return; }
                    if (targetBtn.classList.contains('info-btn')) { 
                        const itemsList = document.getElementById('info-modal-items');
                        const itemsStr = targetBtn.dataset.modalItems;
                        document.getElementById('info-modal-title').textContent = targetBtn.dataset.modalTitle;
                        document.getElementById('info-modal-desc').textContent = targetBtn.dataset.modalDesc;
                        if(itemsList) itemsList.innerHTML = '';
                        if (itemsList && itemsStr && (itemsStr.trim().startsWith('[') || itemsStr.trim().startsWith('{'))) {
                          try { JSON.parse(itemsStr).forEach(item => { const li = document.createElement('li'); li.textContent = item; itemsList.appendChild(li); });
                          } catch(err) { console.warn("Error parsing modalItems JSON:", err) }
                        }
                        if(infoModalOverlay) infoModalOverlay.classList.add('visible'); return; 
                    }
                    if (targetBtn.classList.contains('task-status-btn')) { 
                        const key = targetBtn.dataset.key; 
                        const currentStatus = Number(state.userData?.[key] ?? 0); 
                        const newStatus = (currentStatus + 1) % 7; // Logic Fix: 7 states (0-6)
                        const fillValue = (newStatus <= 4) ? newStatus * 20 : 100;
                        const isDone = newStatus === 5; 
                        const isWont = newStatus === 6; 
                        const statusText = isWont ? '‚úñ' : (isDone ? tickIconSVG : `${newStatus * 20}%`); 

                        targetBtn.style.setProperty('--fill', `${fillValue}%`);
                        targetBtn.classList.toggle('wont', isWont);
                        targetBtn.classList.toggle('done', isDone);
                        const iconSpan = targetBtn.querySelector('span'); 
                        if (iconSpan) { iconSpan.innerHTML = statusText; } 
                        updateState(`userData.${key}`, newStatus); 
                        return;
                    }
                    if (targetBtn.classList.contains('note-btn')) { openNoteModal(targetBtn.dataset.key, targetBtn.dataset.title); return; }
                }

                // --- Goal Tracker Actions (Event Delegation) ---
                const goalCard = target.closest('#goal-tracker-card');
                if (goalCard) {
                    const tabBtn = target.closest('.goal-tab');
                    if (tabBtn) { state.activeGoalTab = tabBtn.dataset.tab; if(tabBtn.dataset.tab !== 'weekly') state.currentWeeklyViewDate = new Date().toISOString(); renderGoalsCard(); return; }

                    const tickBtn = target.closest('.goal-tick-btn');
                    if (tickBtn) { const goalId = tickBtn.closest('.goal-list-item').dataset.goalId; toggleGoal(goalId); return; }

                    const deleteBtn = target.closest('.goal-delete-btn');
                    if (deleteBtn) { const goalId = deleteBtn.closest('.goal-list-item').dataset.goalId; deleteGoal(goalId); return; }

                    if(target.id === 'view-specific-date-btn') { const datePicker = document.getElementById('history-date-picker'); if (datePicker && datePicker.value) { state.historyViewState.mode = 'specificDate'; state.historyViewState.selectedDate = datePicker.value; renderGoalsCard(); } }
                    if(target.id === 'view-last-7-days-btn') { state.historyViewState.mode = 'last7days'; state.historyViewState.selectedDate = null; renderGoalsCard(); }

                    if(target.closest('#week-selector-label')) {
                        const dateInput = document.getElementById('week-selector-input');
                        if(dateInput) dateInput.click();
                    }
                }
            });
            
             document.body.addEventListener('change', e => {
                const target = e.target;
                 if (target.classList.contains('goal-date-editor')) {
                    const goalId = target.closest('.goal-list-item').dataset.goalId;
                    updateGoalDate(goalId, target.value);
                    target.classList.add('hidden');
                }
                if (target.id === 'week-selector-input') {
                    state.currentWeeklyViewDate = new Date(target.value).toISOString();
                    renderGoalsCard();
                }
            });

            document.body.addEventListener('submit', e => {
                 if (e.target.id === 'goal-add-form') {
                    e.preventDefault();
                    const input = e.target.querySelector('input[type="text"]');
                    const dateInput = e.target.querySelector('input[type="date"]');
                    if (input && input.value.trim()) {
                        addGoal(input.value.trim(), dateInput.value);
                        input.value = '';
                        dateInput.value = '';
                    }
                }
            });

            const closeInfoModal = () => infoModalOverlay.classList.remove('visible');
            infoModalOverlay.addEventListener('click', e => { if (e.target === infoModalOverlay) closeInfoModal(); });
            document.getElementById('info-modal-close')?.addEventListener('click', closeInfoModal);
            
            const syllabusContent = document.getElementById('syllabus-content');
            if (syllabusContent) { syllabusContent.addEventListener('toggle', (e) => { if (e.target.tagName === 'DETAILS') { const paper = e.target.dataset.paper; if(paper) state.syllabusOpenState[`${state.activeSubject}-${paper}`] = e.target.open; } }, true); }
        }
        
        function addGoal(title, dueDate) {
            const newGoal = { id: `g_${Date.now()}`, title, completed: false, createdAt: new Date().toISOString(), dueDate: dueDate || null };
            const currentGoals = state.userData.goals || { today: [], weekly: [] };
            const todayISO = new Date().toISOString().slice(0, 10);

            if (state.activeGoalTab === 'today') {
                currentGoals.today.push(newGoal);
                if (!currentGoals.weekly.find(g => g.id === newGoal.id)) { currentGoals.weekly.push(newGoal); }
            } else if (state.activeGoalTab === 'weekly') {
                currentGoals.weekly.push(newGoal);
                if (dueDate === todayISO && !currentGoals.today.find(g => g.id === newGoal.id)) { currentGoals.today.push(newGoal); }
            }
            updateState('userData.goals', currentGoals);
        }

        let undoTimeout;
        function toggleGoal(goalId) {
            const currentGoals = JSON.parse(JSON.stringify(state.userData.goals || { today: [], weekly: [] }));
            let goalToday = currentGoals.today.find(g => g.id === goalId);
            let goalWeekly = currentGoals.weekly.find(g => g.id === goalId);
            if (!goalToday && !goalWeekly) return;
            const wasCompleted = goalToday ? goalToday.completed : goalWeekly.completed;
            const newCompletedState = !wasCompleted;
            const completedAt = newCompletedState ? new Date().toISOString() : null;
            if(goalToday) { goalToday.completed = newCompletedState; goalToday.completedAt = completedAt; }
            if(goalWeekly) { goalWeekly.completed = newCompletedState; goalWeekly.completedAt = completedAt; }
            updateState('userData.goals', currentGoals);

            if (wasCompleted) { 
                clearTimeout(undoTimeout);
                const undoAction = () => {
                    const freshGoals = JSON.parse(JSON.stringify(state.userData.goals || { today: [], weekly: [] }));
                    let goalToRevertToday = freshGoals.today.find(g => g.id === goalId);
                    let goalToRevertWeekly = freshGoals.weekly.find(g => g.id === goalId);
                    if (goalToRevertToday) { goalToRevertToday.completed = true; goalToRevertToday.completedAt = completedAt; }
                    if (goalToRevertWeekly) { goalToRevertWeekly.completed = true; goalToRevertWeekly.completedAt = completedAt; }
                    updateState('userData.goals', freshGoals);
                };
                showToast("‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", 'success', { actionText: "‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞", action: undoAction, duration: 5000 });
            }
        }

        function deleteGoal(goalId) {
             const currentGoals = JSON.parse(JSON.stringify(state.userData.goals || { today: [], weekly: [] }));
             currentGoals.today = currentGoals.today.filter(g => g.id !== goalId);
             currentGoals.weekly = currentGoals.weekly.filter(g => g.id !== goalId);
             updateState('userData.goals', currentGoals);
        }

        function updateGoalDate(goalId, newDueDate) {
            const currentGoals = JSON.parse(JSON.stringify(state.userData.goals || { today: [], weekly: [] }));
            let goalToday = currentGoals.today.find(g => g.id === goalId);
            let goalWeekly = currentGoals.weekly.find(g => g.id === goalId);
            const todayISO = new Date().toISOString().slice(0, 10);
            
            // Update date in weekly list first
            if (goalWeekly) {
                goalWeekly.dueDate = newDueDate;
            }

            // Sync with today list
            const isInTodayList = !!goalToday;
            const shouldBeInTodayList = newDueDate === todayISO;

            if (shouldBeInTodayList && !isInTodayList) {
                // To avoid duplicates, we need to make sure we're adding the reference from weekly
                const goalRef = currentGoals.weekly.find(g => g.id === goalId);
                if(goalRef) currentGoals.today.push(goalRef);
            } else if (!shouldBeInTodayList && isInTodayList) {
                currentGoals.today = currentGoals.today.filter(g => g.id !== goalId);
            }

            updateState('userData.goals', currentGoals);
        }

        let countdownInterval;
        function startCountdown() { if(countdownInterval) clearInterval(countdownInterval); const target = new Date(`${TARGET_DATE_STRING}T00:00:00+06:00`); const countdownEl = document.getElementById('countdown'); if(!countdownEl) return; const tick = () => { try { const diff = Math.max(0, target - new Date()); const d = Math.floor(diff / 864e5), h = Math.floor((diff % 864e5) / 36e5), m = Math.floor((diff % 36e5) / 6e4), s = Math.floor((diff % 6e4) / 1e3); countdownEl.innerHTML = `<div class="text-center"><div class="countdown-num">${d}</div><div class="countdown-label">‡¶¶‡¶ø‡¶®</div></div><div class="text-center"><div class="countdown-num">${String(h).padStart(2,'0')}</div><div class="countdown-label">‡¶ò‡¶£‡ßç‡¶ü‡¶æ</div></div><div class="text-center"><div class="countdown-num">${String(m).padStart(2,'0')}</div><div class="countdown-label">‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü</div></div><div class="text-center"><div class="countdown-num">${String(s).padStart(2,'0')}</div><div class="countdown-label">‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°</div></div>`; } catch(e){ console.error("Countdown tick error:", e); clearInterval(countdownInterval)} }; try { tick(); countdownInterval = setInterval(tick, 1000); } catch(e){ console.error("Countdown setup error:", e) } }
        async function setupThemeToggle() { const btn = document.getElementById('theme-toggle-btn'); const meta = document.getElementById('theme-color-meta'); if (!btn || !meta) return; const applyTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'; meta.content = theme === 'dark' ? '#1c1c1c' : '#f8f7f2'; }; btn.addEventListener('click', async () => { const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; try { await writeToDB('userData', { id: 'setting_theme', value: newTheme }); } catch (e) { console.error("Failed to save theme:", e); if(e.message === 'QuotaExceededError') showToast('‚ùå Could not save theme: Storage full!', 'error'); else showToast('‚ùå Could not save theme!', 'error'); } applyTheme(newTheme); }); const savedTheme = (await getFromDB('userData', 'setting_theme'))?.value || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); applyTheme(savedTheme); }
        async function setupViewToggle() { const btn = document.getElementById('view-toggle-btn'); const viewportMeta = document.querySelector('meta[name="viewport"]'); if (!btn || !viewportMeta) return; const applyView = (mode) => { if (mode === 'desktop') { document.body.classList.add('desktop-view'); viewportMeta.setAttribute('content', 'width=1280, initial-scale=1'); } else { document.body.classList.remove('desktop-view'); viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.0'); } }; btn.addEventListener('click', async () => { const newMode = document.body.classList.contains('desktop-view') ? 'mobile' : 'desktop'; try { await writeToDB('userData', { id: 'setting_viewMode', value: newMode }); } catch (e) { console.error("Failed to save view mode:", e); if(e.message === 'QuotaExceededError') showToast('‚ùå Could not save view: Storage full!', 'error'); else showToast('‚ùå Could not save view!', 'error'); } applyView(newMode); }); const savedView = (await getFromDB('userData', 'setting_viewMode'))?.value || 'mobile'; applyView(savedView); }

        function exportDataToCSV() {
            try {
                const headers = ['Subject', 'Paper', 'Chapter', 'Item', 'Status', 'Percentage', 'Note', 'LastUpdated'];
                const statusMap = { 0: 'Not Started', 1: 'Reading', 2: 'Re-Reading', 3: 'Practicing', 4: 'Done', 5: "Won't Do" };
                const dataRows = Object.keys(state.userData).filter(key => key.startsWith('s_')).map(key => { const parts = key.replace('s_', '').split('_'); const subjectKey = parts[0]; const chapterId = parseInt(parts[1]); const itemIndex = parseInt(parts[2]); const subject = syllabusData[subjectKey]; const chapter = subject?.chapters.find(c => c.id === chapterId); const item = trackableItems[itemIndex]; if (!subject || !chapter || !item) return null; const statusValue = state.userData[key] ?? 0; const noteKey = `note_${key}`; const timestampKey = `timestamp_${key}`; const safeNote = (state.userData[noteKey] || '').replace(/"/g, '""').replace(/\r?\n/g, ' '); const row = [subject.name, chapter.paper, chapter.name, item, statusMap[statusValue], getRawPercentForStatus(statusValue), safeNote, state.userData[timestampKey] || '']; return `"${row.join('","')}"`; }).filter(Boolean);
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...dataRows].join('\n');
                const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `as_study_dashboard_export_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast('‚úÖ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!', 'success');
            } catch (e) { console.error("CSV Export Failed:", e); showToast('‚ùå CSV ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá!', 'error'); }
        }

        function exportDataToJSON() {
            try {
                const blob = new Blob([JSON.stringify(state.userData, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `as_study_dashboard_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('‚úÖ JSON ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!', 'success');
            } catch (e) { console.error("JSON Export Failed:", e); showToast('‚ùå JSON ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá!', 'error'); }
        }

        function renderAll() { try { renderSubjectSelector(); renderProgressCards(); renderSyllabusContent(); renderStudyStreak(); renderGoalsCard(); updateSyncQueueCount(); } catch (e) { console.error("RenderAll failed:", e); const container = document.getElementById('app-container'); if (container) container.innerHTML = '<div class="text-red-500 p-4">Error rendering dashboard. Check console.</div>'; }}

        async function startApp() {
            noteModalOverlay = document.getElementById('note-modal-overlay'); noteModalTitle = document.getElementById('note-modal-title'); noteTextarea = document.getElementById('note-textarea'); syncModalOverlay = document.getElementById('sync-modal-overlay');
            const syncStatusEl = document.getElementById('connection-status');
            const loadingIndicator = document.getElementById('loading-indicator');
            const mainContentGrid = document.getElementById('main-content-grid');
            if (!syncStatusEl || !loadingIndicator || !mainContentGrid) { console.error("Critical elements missing. Aborting."); document.body.innerHTML = "Initialization Error: Required elements not found."; return; }
            syncStatusEl.textContent = 'Initializing...';
            try { await openDB(); syncStatusEl.textContent = 'Loading cache...'; const cachedData = await getFromDB('userData', 'main'); if (cachedData) { state.userData = cachedData.value || {}; if(!state.userData.goals) state.userData.goals = {today:[], weekly:[]}; } } catch (e) { console.error("DB/Cache Load failed:", e); syncStatusEl.textContent = 'DB Error'; }
            
            // Render from cache first for instant UI
            try { renderAll(); loadingIndicator.style.display = 'none'; mainContentGrid.style.display = 'grid'; state.isInitialized = true; } catch (e) { console.error("Initial render from cache failed:", e); loadingIndicator.textContent = 'Error during initial render. Check console.'; }
            
            if(db && userDocRef) { 
                syncStatusEl.textContent = 'Connecting...'; 
                let isFirstSnapshot = true; 
                try { 
                    onSnapshot(userDocRef, async (snap) => { 
                        let requiresUpdate = false; 
                        if (snap.exists()) { 
                            const firestoreData = snap.data(); 
                            if (!firestoreData.goals) firestoreData.goals = {today:[], weekly:[]};
                            Object.keys(firestoreData).forEach(key => { 
                                if (JSON.stringify(state.userData[key]) !== JSON.stringify(firestoreData[key])) { 
                                    state.userData[key] = firestoreData[key]; 
                                    requiresUpdate = true; 
                                } 
                            }); 
                            if (requiresUpdate || isFirstSnapshot) {
                                try { await writeToDB('userData', { id: 'main', value: state.userData }); } 
                                catch (e) { console.error("Failed to write snapshot data to IDB:", e); if (e.message === 'QuotaExceededError') { showToast('‚ùå Storage full! Cannot save synced data.', 'error'); } } 
                                if (state.isInitialized) { 
                                    renderAll();
                                    state.lastCompositeProgress = calculateComposite().composite;
                                    if(!isFirstSnapshot) { showToast('üîÑ ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡ßü‡ßá‡¶õ‡ßá!', 'success'); }
                                } 
                            }
                        } else { console.warn("User document doesn't exist in Firestore."); } 
                        isFirstSnapshot = false; 
                        syncPendingWrites(); 
                    }, (error) => { console.error("Firestore onSnapshot error:", error); syncStatusEl.textContent = 'Sync Failed'; syncStatusEl.className = 'status-indicator offline'; }); 
                } catch(e) { console.error("onSnapshot setup failed:", e); syncStatusEl.textContent = 'Firebase Error'; syncStatusEl.className = 'status-indicator offline';} 
            } else { syncStatusEl.textContent = 'Firebase Failed'; syncStatusEl.className = 'status-indicator offline'; }

            if (state.isInitialized) {
                setupEventHandlers(); setupModalEventHandlers(); setupInfoButtons(); startCountdown(); await setupViewToggle(); await setupThemeToggle();
                const banner = document.getElementById('offline-banner');
                window.addEventListener('online', () => { if (banner) banner.style.display = 'none'; try { syncPendingWrites(); } catch(e) { console.warn('syncPendingWrites failed on online event', e); } });
                window.addEventListener('offline', () => { if (banner) banner.style.display = 'block'; if (syncStatusEl) { syncStatusEl.textContent = 'Offline'; syncStatusEl.className = 'status-indicator offline'; } });
                if (!navigator.onLine && banner) banner.style.display = 'block';
                syncPendingWrites();
                window.addEventListener('beforeunload', () => clearInterval(countdownInterval));
            }
        }
        startApp();
    </script>
</body>
</html>

