<!DOCTYPE html>
<html lang="bn" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" content="notranslate" />
    <meta name="theme-color" id="theme-color-meta" content="#1c1c1c" />
    <title>AS Study Dashboard v9.5</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet" />

    <style>
        :root { 
            --bg-main: #f8f7f2; --bg-card: #ffffff; --bg-header: rgba(248,247,242,0.9); 
            --text-primary: #3b2b22; --text-secondary: #1f2937; --text-muted: #6b6b6b; 
            --border-primary: #e6d7c9; --border-secondary: #f3ece6; 
            /* Fix 2: More visible progress bar track */
            --progress-track: #d1d5db; /* Tailwind gray-300 */
        }
        html[data-theme="dark"] { 
            --bg-main: #1c1c1c; --bg-card: #2a2a2a; --bg-header: rgba(28, 28, 28, 0.85); 
            --text-primary: #e5e7eb; --text-secondary: #f3f4f6; --text-muted: #9ca3af; 
            --border-primary: #4b5563; --border-secondary: #374151; 
             /* Fix 2: More visible progress bar track */
            --progress-track: #4b5563; /* Tailwind gray-600 */
        }
        
        html, body { height: 100%; margin: 0; background: var(--bg-main); color: var(--text-primary); font-family: 'Noto Sans Bengali', sans-serif; -webkit-font-smoothing: antialiased; }
        .card { background: var(--bg-card); border-radius: 12px; padding: 18px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07); border: 1px solid var(--border-secondary); }
        .progress-bar-container { background-color: var(--progress-track); border-radius: 9999px; overflow: hidden; height: 0.5rem; } /* h-2 */
        .progress-bar { height: 100%; border-radius: 9999px; transition: width 0.4s ease-out; }
        
        /* Fix 2: Gradient Progress Bar Colors */
        .pb-gradient-mint { background: linear-gradient(90deg, #6ee7b7, #34d399); }
        .pb-gradient-sky { background: linear-gradient(90deg, #7dd3fc, #38bdf8); }
        .pb-gradient-peach { background: linear-gradient(90deg, #fb923c, #f97316); }
        .pb-gradient-lav { background: linear-gradient(90deg, #c4b5fd, #a78bfa); }
        .pb-gradient-amber { background: linear-gradient(90deg, #fcd34d, #fbbf24); }
        .pb-gradient-cyan { background: linear-gradient(90deg, #67e8f9, #22d3ee); }
        .pb-gradient-rose { background: linear-gradient(90deg, #fb7185, #f43f5e); }

        #countdown-card { background: linear-gradient(135deg, #d90429, #ef233c); box-shadow: 0 10px 25px rgba(217, 4, 41, 0.25); }
        .countdown-num { font-weight:800; font-size:24px; } .countdown-label { font-size:12px; opacity:0.95; }
        .subject-progress-svg circle { transition: stroke-dashoffset 0.4s ease-out; }
        .subject-progress-btn.active { border-color: var(--text-primary); background: var(--bg-main); }

        .task-status-btn { --fill: 0%; position: relative; display:inline-flex; align-items:center; justify-content:center; width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--border-secondary); background: transparent; cursor: pointer; overflow: hidden; z-index: 1; transition: transform .08s ease; }
        .task-status-btn::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: var(--fill, 0%); background: linear-gradient(90deg, #7dd3fc, #38bdf8); z-index: -1; transition: width .2s ease-out; }
        .task-status-btn:hover { transform: translateY(-2px); } .task-status-btn.wont { background: #ef4444; border-color: #991b1b; color: #fff !important; }

        .note-btn { background: var(--bg-main); color: var(--text-muted); border: 1px solid var(--border-primary); border-radius: 6px; padding: 4px; cursor: pointer; transition: all 0.2s; opacity: 0.8; line-height: 1; }
        .note-btn:hover { opacity: 1; transform: scale(1.05); border-color: var(--text-muted); color: var(--text-primary); }
        .note-btn.has-note { opacity: 1; background: var(--text-primary); color: var(--bg-card); border-color: var(--text-primary); }
        html[data-theme="dark"] .note-btn.has-note { background: var(--text-primary); color: var(--bg-main); }

        .info-btn { font-family: sans-serif; font-weight: bold; font-size: 14px; cursor: pointer; color: var(--text-muted); border: 1px solid var(--border-primary); border-radius: 50%; width: 22px; height: 22px; display: inline-flex; justify-content: center; align-items: center; transition: all 0.2s; } .info-btn:hover { background: var(--bg-main); transform: scale(1.1); }
        #info-modal-overlay, #note-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #info-modal-overlay.visible, #note-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        #info-modal-content, #note-modal-content { background: var(--bg-card); padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        #info-modal-overlay.visible #info-modal-content, #note-modal-overlay.visible #note-modal-content { transform: scale(1); } 
        #info-modal-content ul { list-style-type: disc; padding-left: 20px; }
        #note-textarea { width: 100%; height: 150px; background: var(--bg-main); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 10px; margin-bottom: 15px; }

        .status-indicator { font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px; user-select: none; }
        .status-indicator.online { background-color: #166534; color: #dcfce7; } .status-indicator.offline { background-color: #991b1b; color: #fee2e2; }

        body.desktop-view { min-width: 1280px; }
        body:not(.desktop-view) .main-grid { grid-template-columns: 1fr; }
        body:not(.desktop-view) .right-column { grid-row-start: 1; }
        body:not(.desktop-view) .card { padding: 14px; }
        body:not(.desktop-view) h1 { font-size: 1.125rem; }
        body:not(.desktop-view) #subject-selector { flex-wrap: wrap; gap: 8px; }
        body:not(.desktop-view) .subject-progress-svg { width: 56px; height: 56px; }
        body.desktop-view .subject-progress-svg { width: 64px; height: 64px; }
        body:not(.desktop-view) .countdown-num { font-size: 20px; }
        body:not(.desktop-view) .countdown-label { font-size: 11px; }
        body:not(.desktop-view) #countdown-card { padding: 16px; }
        body:not(.desktop-view) #header h1 { font-size: 1rem; }
    </style>
</head>
<body class="text-sm">
    <header id="header" class="sticky top-0 z-30 w-full bg-header border-b border-primary backdrop-blur-sm">
        <div class="container max-w-screen-xl mx-auto flex justify-between items-center py-2 px-4">
            <h1 class="text-xl font-bold">AS Study Dashboard</h1>
            <div class="flex items-center gap-3">
                <button id="view-toggle-btn" class="text-xs px-2 py-1 border border-primary rounded-md">Toggle View</button>
                <div id="connection-status" class="status-indicator">...</div>
                <button id="force-sync-btn" class="text-xs px-2 py-1 border border-primary rounded-md">Sync</button>
                <button id="theme-toggle-btn" title="Change theme">üåô</button>
            </div>
        </div>
    </header>

    <main id="app-container" class="container max-w-screen-xl mx-auto py-4 px-4">
        <div class="main-grid grid grid-cols-3 gap-5">
            <div class="left-column col-span-2 flex flex-col gap-5">
                <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® <span id="subject-choice-info-btn"></span></h2><div id="subject-selector" class="flex justify-around"></div></div>
                <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø <span id="main-progress-info-btn"></span></h2><div id="selected-subject-main-progress" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"></div></div>
                <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø <span id="exam-progress-info-btn"></span></h2><div id="selected-subject-exam-progress"></div></div>
                <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø <span id="qb-progress-info-btn"></span></h2><div id="selected-subject-qb-progress" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"></div></div>
                <section id="syllabus-shell" class="card"><h2 class="text-base font-bold mb-3">‡¶∏‡¶ø‡¶≤‡ßá‡¶¨‡¶æ‡¶∏ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h2><div id="syllabus-content"></div></section>
            </div>

            <div class="right-column col-span-1 grid grid-rows-[auto,min-content,1fr] gap-5">
                <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">‡¶∏‡¶æ‡¶Æ‡¶ó‡ßç‡¶∞‡¶ø‡¶ï ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡¶® <span id="composite-info-btn"></span></h2><div id="syllabus-total-container"></div></div>
                <div id="countdown-card" class="card text-white p-5"><h2 class="text-lg font-bold mb-4 text-center">Final Countdown</h2><div id="countdown" class="flex justify-around"></div></div>
                <div class="flex flex-col gap-5">
                    <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">Global Summary <span id="global-summary-info-btn"></span></h2><div id="global-summary-container" class="flex flex-col gap-3"></div></div>
                    <div class="card"><h2 class="text-base font-bold mb-3 flex justify-between items-center">Mini Analytics <span id="analytics-info-btn"></span></h2><div id="analytics-content"></div></div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="info-modal-overlay" role="dialog" aria-modal="true"><div id="info-modal-content"><h3 id="info-modal-title" class="font-bold text-lg mb-2"></h3><p id="info-modal-desc" class="text-muted mb-3 text-sm"></p><div class="mb-2 font-semibold text-sm">‡¶ó‡¶£‡¶®‡¶æ‡¶ï‡ßÉ‡¶§ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ:</div><ul id="info-modal-items" class="text-sm"></ul><button id="info-modal-close" class="mt-4 px-4 py-2 bg-rose-600 text-white rounded-lg w-full">Close</button></div></div>
    <div id="note-modal-overlay" role="dialog" aria-modal="true"><div id="note-modal-content"><h3 id="note-modal-title" class="font-bold text-lg mb-3">Edit Note</h3><textarea id="note-textarea"></textarea><div class="flex justify-between gap-2 mt-4"><button id="note-modal-undo" class="px-3 py-2 text-sm bg-gray-300 text-black rounded-lg">Undo</button><button id="note-modal-clear" class="px-3 py-2 text-sm bg-yellow-500 text-black rounded-lg">Clear</button><div class="flex-grow"></div><button id="note-modal-cancel" class="px-4 py-2 text-sm bg-gray-500 text-white rounded-lg">Cancel</button><button id="note-modal-save" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg">Save</button></div></div></div>
    <div id="toast-container" class="fixed right-4 bottom-5 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Firebase Config ---
        const firebaseConfig = {"apiKey":"AIzaSyDTLhIkrW9qk6KPT_gTDibIiJeVwWYTowk","authDomain":"my-study-dashboard.firebaseapp.com","projectId":"my-study-dashboard","storageBucket":"my-study-dashboard.appspot.com","messagingSenderId":"66307909031","appId":"1:66307909031:web:9e724a43c8c11a0ef80282"};
        let app, db, userDocRef;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); userDocRef = doc(db, "users", "as19", "progress", "main"); } catch (e) { console.error("Firebase initialization failed:", e); }

        // --- IndexedDB Setup ---
        const DB_NAME = 'AdnanStudyDashboardDB_v1'; const DB_VERSION = 1; let idb;
        function openDB() { return new Promise((resolve, reject) => { try { const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = (e) => reject("Error opening DB: " + e.target.errorCode); request.onsuccess = (e) => { idb = e.target.result; resolve(idb); }; request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains('userData')) db.createObjectStore('userData', { keyPath: 'id' }); if (!db.objectStoreNames.contains('pendingWrites')) db.createObjectStore('pendingWrites', { keyPath: 'key' }); }; } catch(e) { reject(e); } }); }
        async function getFromDB(storeName, key) { if (!idb) return null; return new Promise((resolve) => { try { const tx = idb.transaction(storeName, 'readonly'); const store = tx.objectStore(storeName); const req = store.get(key); req.onsuccess = () => resolve(req.result); tx.onerror = () => resolve(null); } catch (e) { resolve(null); } }); }
        async function getAllFromDB(storeName) { if (!idb) return []; return new Promise((resolve) => { try { const tx = idb.transaction(storeName, 'readonly'); const store = tx.objectStore(storeName); const req = store.getAll(); req.onsuccess = () => resolve(req.result); tx.onerror = () => resolve([]); } catch(e) { resolve([]); } }); }
        async function writeToDB(storeName, data) { if (!idb) return; return new Promise((resolve, reject) => { try { const tx = idb.transaction(storeName, 'readwrite'); tx.oncomplete = () => resolve(); tx.onerror = (e) => reject(tx.error); const store = tx.objectStore(storeName); store.put(data); } catch (e) { reject(e); } }); }
        async function clearDBStore(storeName) { if (!idb) return; return new Promise((resolve, reject) => { try { const tx = idb.transaction(storeName, 'readwrite'); tx.oncomplete = () => resolve(); tx.onerror = (e) => reject(tx.error); const store = tx.objectStore(storeName); store.clear(); } catch(e) { reject(e); } }); }

        // --- App State & Data ---
        const state = { userData: {}, activeSubject: 'biology', syllabusOpenState: {} };
        const syllabusData = { biology: { name: "‡¶ú‡ßÄ‡¶¨‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", chapters: [ { id: 1, name: "‡¶ï‡ßã‡¶∑ ‡¶ì ‡¶è‡¶∞ ‡¶ó‡¶†‡¶®", paper: 1 }, { id: 2, name: "‡¶ï‡ßã‡¶∑ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ú‡¶®", paper: 1 }, { id: 3, name: "‡¶ï‡ßã‡¶∑ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 1 }, { id: 4, name: "‡¶Ö‡¶£‡ßÅ‡¶ú‡ßÄ‡¶¨", paper: 1 }, { id: 5, name: "‡¶∂‡ßà‡¶¨‡¶æ‡¶≤ ‡¶ì ‡¶õ‡¶§‡ßç‡¶∞‡¶æ‡¶ï", paper: 1 }, { id: 6, name: "‡¶¨‡ßç‡¶∞‡¶æ‡¶Ø‡¶º‡ßã‡¶´‡¶æ‡¶á‡¶ü‡¶æ ‡¶ì ‡¶ü‡ßá‡¶∞‡¶ø‡¶°‡ßã‡¶´‡¶æ‡¶á‡¶ü‡¶æ", paper: 1 }, { id: 7, name: "‡¶®‡¶ó‡ßç‡¶®‡¶¨‡ßÄ‡¶ú‡¶ø ‡¶ì ‡¶Ü‡¶¨‡ßÉ‡¶§‡¶¨‡ßÄ‡¶ú‡¶ø ‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶", paper: 1 }, { id: 8, name: "‡¶ü‡¶ø‡¶∏‡ßç‡¶Ø‡ßÅ ‡¶ì ‡¶ü‡¶ø‡¶∏‡ßç‡¶Ø‡ßÅ‡¶§‡¶®‡ßç‡¶§‡ßç‡¶∞", paper: 1 }, { id: 9, name: "‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨", paper: 1 }, { id: 10, name: "‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶ ‡¶™‡ßç‡¶∞‡¶ú‡¶®‡¶®", paper: 1 }, { id: 11, name: "‡¶ú‡ßÄ‡¶¨ ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø", paper: 1 }, { id: 12, name: "‡¶ú‡ßÄ‡¶¨‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂, ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞ ‡¶ì ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£", paper: 1 }, { id: 13, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶¨‡ßà‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡ßç‡¶Ø ‡¶ì ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø‡¶¨‡¶ø‡¶®‡ßç‡¶Ø‡¶æ‡¶∏", paper: 2 }, { id: 14, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø (‡¶π‡¶æ‡¶á‡¶°‡ßç‡¶∞‡¶æ)", paper: 2 }, { id: 15, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø (‡¶ò‡¶æ‡¶∏‡¶´‡¶°‡¶º‡¶ø‡¶Ç)", paper: 2 }, { id: 16, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø (‡¶∞‡ßÅ‡¶á ‡¶Æ‡¶æ‡¶õ)", paper: 2 }, { id: 17, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶™‡¶∞‡¶ø‡¶™‡¶æ‡¶ï ‡¶ì ‡¶∂‡ßã‡¶∑‡¶£", paper: 2 }, { id: 18, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶∞‡¶ï‡ßç‡¶§ ‡¶ì ‡¶∏‡¶û‡ßç‡¶ö‡¶æ‡¶≤‡¶®", paper: 2 }, { id: 19, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ì ‡¶∂‡ßç‡¶¨‡¶∏‡¶®", paper: 2 }, { id: 20, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶¨‡¶∞‡ßç‡¶ú‡ßç‡¶Ø ‡¶ì ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∂‡¶®", paper: 2 }, { id: 21, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶ö‡¶≤‡¶® ‡¶ì ‡¶Ö‡¶ô‡ßç‡¶ó‡¶ö‡¶æ‡¶≤‡¶®‡¶æ", paper: 2 }, { id: 22, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶∏‡¶Æ‡¶®‡ßç‡¶¨‡¶Ø‡¶º ‡¶ì ‡¶®‡¶ø‡¶Ø‡¶º‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£", paper: 2 }, { id: 23, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶ú‡ßÄ‡¶¨‡¶®‡ßá‡¶∞ ‡¶ß‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶ø‡¶ï‡¶§‡¶æ", paper: 2 }, { id: 24, name: "‡¶Æ‡¶æ‡¶®‡¶¨‡¶¶‡ßá‡¶π‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∞‡¶ï‡ßç‡¶∑‡¶æ", paper: 2 }, { id: 25, name: "‡¶ú‡¶ø‡¶®‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨ ‡¶ì ‡¶¨‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®", paper: 2 }, { id: 26, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶Ü‡¶ö‡¶∞‡¶£", paper: 2 } ] }, chemistry: { name: "‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", chapters: [ { id: 1, name: "‡¶≤‡ßç‡¶Ø‡¶æ‡¶¨‡¶∞‡ßá‡¶ü‡¶∞‡¶ø‡¶∞ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞", paper: 1 }, { id: 2, name: "‡¶ó‡ßÅ‡¶£‡¶ó‡¶§ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 1 }, { id: 3, name: "‡¶Æ‡ßå‡¶≤‡ßá‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡¶¨‡ßÉ‡¶§‡ßç‡¶§ ‡¶ß‡¶∞‡ßç‡¶Æ ‡¶ì ‡¶∞‡¶æ‡¶∏‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶ß‡¶®", paper: 1 }, { id: 4, name: "‡¶∞‡¶æ‡¶∏‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®", paper: 1 }, { id: 5, name: "‡¶ï‡¶∞‡ßç‡¶Æ‡¶Æ‡ßÇ‡¶ñ‡ßÄ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 1 }, { id: 6, name: "‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 7, name: "‡¶ú‡ßà‡¶¨ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 8, name: "‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£‡¶ó‡¶§ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 9, name: "‡¶§‡¶°‡¶º‡¶ø‡ßé ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 10, name: "‡¶Ö‡¶∞‡ßç‡¶•‡¶®‡ßà‡¶§‡¶ø‡¶ï ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 } ] }, physics: { name: "‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", chapters: [ { id: 1, name: "‡¶≠‡ßå‡¶§ ‡¶ú‡¶ó‡¶§ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™", paper: 1 }, { id: 2, name: "‡¶≠‡ßá‡¶ï‡ßç‡¶ü‡¶∞", paper: 1 }, { id: 3, name: "‡¶ó‡¶§‡¶ø‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ", paper: 1 }, { id: 4, name: "‡¶®‡¶ø‡¶â‡¶ü‡¶®‡¶ø‡¶Ø‡¶º‡¶æ‡¶® ‡¶¨‡¶≤‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ", paper: 1 }, { id: 5, name: "‡¶ï‡¶æ‡¶ú, ‡¶∂‡¶ï‡ßç‡¶§‡¶ø ‡¶ì ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ", paper: 1 }, { id: 6, name: "‡¶Æ‡¶π‡¶æ‡¶ï‡¶∞‡ßç‡¶∑ ‡¶ì ‡¶Ö‡¶≠‡¶ø‡¶ï‡¶∞‡ßç‡¶∑", paper: 1 }, { id: 7, name: "‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡ßá‡¶∞ ‡¶ó‡¶æ‡¶†‡¶®‡¶ø‡¶ï ‡¶ß‡¶∞‡ßç‡¶Æ", paper: 1 }, { id: 8, name: "‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶ó‡¶§‡¶ø", paper: 1 }, { id: 9, name: "‡¶§‡¶∞‡¶ô‡ßç‡¶ó", paper: 1 }, { id: 10, name: "‡¶Ü‡¶¶‡¶∞‡ßç‡¶∂ ‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏ ‡¶ì ‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ó‡¶§‡¶ø‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨", paper: 1 }, { id: 11, name: "‡¶§‡¶æ‡¶™‡¶ó‡¶§‡¶ø‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ", paper: 2 }, { id: 12, name: "‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶§‡¶°‡¶º‡¶ø‡ßé", paper: 2 }, { id: 13, name: "‡¶ö‡¶≤ ‡¶§‡¶°‡¶º‡¶ø‡ßé", paper: 2 }, { id: 14, name: "‡¶§‡¶°‡¶º‡¶ø‡ßé ‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶π‡ßá‡¶∞ ‡¶ö‡ßå‡¶Æ‡ßç‡¶¨‡¶ï ‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ì ‡¶ö‡ßÅ‡¶Æ‡ßç‡¶¨‡¶ï‡¶§‡ßç‡¶¨", paper: 2 }, { id: 15, name: "‡¶§‡¶°‡¶º‡¶ø‡ßé ‡¶ö‡ßå‡¶Æ‡ßç‡¶¨‡¶ï ‡¶Ü‡¶¨‡ßá‡¶∂ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶π", paper: 2 }, { id: 16, name: "‡¶ú‡ßç‡¶Ø‡¶æ‡¶Æ‡¶ø‡¶§‡¶ø‡¶ï ‡¶Ü‡¶≤‡ßã‡¶ï‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", paper: 2 }, { id: 17, name: "‡¶≠‡ßå‡¶§ ‡¶Ü‡¶≤‡ßã‡¶ï‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ", paper: 2 }, { id: 18, name: "‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡ßÇ‡¶ö‡¶®‡¶æ", paper: 2 }, { id: 19, name: "‡¶™‡¶∞‡¶Æ‡¶æ‡¶£‡ßÅ‡¶∞ ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶â‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", paper: 2 }, { id: 20, name: "‡¶∏‡ßá‡¶Æ‡¶ø‡¶ï‡¶®‡ßç‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡¶∞ ‡¶ì ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡¶∏", paper: 2 }, { id: 21, name: "‡¶ú‡ßç‡¶Ø‡ßã‡¶§‡¶ø‡¶∞‡ßç‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", paper: 2 } ] } };
        const trackableItems = ["‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á", "Class", "Rev Class", "Meditrics", "MQB (Unmesh)", "Retina QB", "Secret Files Exam", "Daily Exam", "Weekly Exam", "Campus Exam", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ßß", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ß®"];
        const mainStudyItems = ["‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á", "Class", "Meditrics"]; const revisionItems = ["‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ßß", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ß®", "Rev Class"]; const examItems = ["Secret Files Exam", "Daily Exam", "Weekly Exam", "Campus Exam"]; const qbItems = ["MQB (Unmesh)", "Retina QB"];

        // --- Calculation Logic (Unchanged but safer with ?? 0) ---
        const getRawPercentForStatus = (status) => (typeof status === 'number' && status >= 0 && status <= 4) ? status * 20 : 0;
        const normalizeRawTo100 = (raw) => raw <= 0 ? 0 : Math.min(100, (raw / 80) * 100);
        function calculateProgress(subjectKey, itemsToCount) { let currentItems = [...itemsToCount]; if (subjectKey === 'physics') currentItems = currentItems.filter(item => item !== '‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á'); const subjectData = syllabusData[subjectKey]; if (!subjectData || !subjectData.chapters) return { overall: 0, paper1: 0, paper2: 0 }; const mulBoiIndex = trackableItems.indexOf("‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á"); const meditricsIndex = trackableItems.indexOf("Meditrics"); const useMaxLogic = currentItems.includes("‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á") && currentItems.includes("Meditrics"); let itemIndices = currentItems.map(item => trackableItems.indexOf(item)).filter(i => i >= 0); let p1Sum = 0, p1Count = 0, p2Sum = 0, p2Count = 0; subjectData.chapters.forEach(ch => { let rawSum = 0; let itemsForAvg = itemIndices.length; if (useMaxLogic) { const nonSpecial = itemIndices.filter(i => i !== mulBoiIndex && i !== meditricsIndex); nonSpecial.forEach(i => { rawSum += getRawPercentForStatus(state.userData?.[`s_${subjectKey}_${ch.id}_${i}`] ?? 0); }); const mulBoiStatus = getRawPercentForStatus(state.userData?.[`s_${subjectKey}_${ch.id}_${mulBoiIndex}`] ?? 0); const medStatus = getRawPercentForStatus(state.userData?.[`s_${subjectKey}_${ch.id}_${meditricsIndex}`] ?? 0); rawSum += Math.max(mulBoiStatus, medStatus); itemsForAvg = nonSpecial.length + 1; } else { itemIndices.forEach(i => { rawSum += getRawPercentForStatus(state.userData?.[`s_${subjectKey}_${ch.id}_${i}`] ?? 0); }); } const normalized = normalizeRawTo100(itemsForAvg > 0 ? rawSum / itemsForAvg : 0); if (ch.paper === 1) { p1Sum += normalized; p1Count++; } else { p2Sum += normalized; p2Count++; } }); const paper1 = p1Count > 0 ? p1Sum / p1Count : 0; const paper2 = p2Count > 0 ? p2Sum / p2Count : 0; const overall = (p1Count + p2Count > 0) ? (p1Sum + p2Sum) / (p1Count + p2Count) : 0; return { overall, paper1, paper2 }; }
        const calculateComposite = () => { const subjects = Object.keys(syllabusData); if(!subjects.length) return { mainAvg: 0, revAvg: 0, examAvg: 0, qbAvg: 0, composite: 0 }; const mainAvg = calculateGlobalAverage(s => calculateProgress(s, mainStudyItems)).overall; const revAvg = calculateGlobalAverage(s => calculateProgress(s, revisionItems)).overall; const examAvg = calculateGlobalAverage(s => calculateProgress(s, examItems)).overall; const qbAvg = calculateGlobalAverage(s => calculateProgress(s, qbItems)).overall; return { mainAvg, revAvg, examAvg, qbAvg, composite: (mainAvg + revAvg + examAvg + qbAvg) / 4 }; };
        const calculateGlobalAverage = (fn) => { const subjects = Object.keys(syllabusData); let total = 0; subjects.forEach(key => { total += fn(key).overall; }); return { overall: total / (subjects.length || 1) }; };
        const findWeakestSubject = () => { const subjects = Object.keys(syllabusData); if (!subjects.length) return null; let weakest = { name: '', score: 101 }; subjects.forEach(key => { const progress = calculateProgress(key, [...mainStudyItems, ...revisionItems, ...examItems, ...qbItems]); if (progress.overall < weakest.score) { weakest = { name: syllabusData[key].name, score: progress.overall }; } }); return weakest; };
        
        // --- UI Rendering Functions ---
        const createInfoButton = (data) => { const btn = document.createElement('button'); btn.className = 'info-btn'; btn.textContent = '?'; Object.entries(data).forEach(([k, v]) => { btn.dataset[k] = Array.isArray(v) ? JSON.stringify(v) : v; }); return btn; };
        // Fix 2: Use Gradient Classes
        const createProgressBar = (p, color) => `<div class="w-full progress-bar-container"><div class="progress-bar pb-gradient-${color} h-2" style="width: ${p.toFixed(1)}%"></div></div>`;
        const createBreakdownProgressBar = (data, title, colors=['sky','peach','lav']) => `<div class="flex flex-col gap-2"> <div class="font-bold text-sm">${title}</div> <div class="grid grid-cols-[40px,1fr,45px] items-center gap-2 text-xs"> <span>‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞</span>${createProgressBar(data.paper1, colors[0])}<span class="text-right font-medium">${data.paper1.toFixed(1)}%</span> <span>‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞</span>${createProgressBar(data.paper2, colors[1])}<span class="text-right font-medium">${data.paper2.toFixed(1)}%</span> <span class="font-bold">‡¶Æ‡ßã‡¶ü</span>${createProgressBar(data.overall, colors[2])}<span class="text-right font-bold">${data.overall.toFixed(1)}%</span> </div></div>`;
        const createCircularProgressBar = (p, color) => `<svg class="subject-progress-svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" stroke="var(--progress-track)" stroke-width="5" fill="none" /><circle cx="32" cy="32" r="28" stroke="${color}" stroke-width="5" fill="none" stroke-dasharray="${2 * Math.PI * 28}" stroke-dashoffset="${(1 - (p/100)) * 2 * Math.PI * 28}" stroke-linecap="round" /></svg>`;
        function renderSubjectSelector() { const container = document.getElementById('subject-selector'); if(!container) return; const fragment = document.createDocumentFragment(); const colors = ['#34d399', '#f97316', '#38bdf8']; Object.keys(syllabusData).forEach((key, idx) => { const btn = document.createElement('div'); const isActive = state.activeSubject === key; const progress = calculateProgress(key, mainStudyItems); btn.className = `subject-progress-btn ${isActive ? 'active' : ''}`; btn.dataset.subject = key; btn.innerHTML = `<div class="relative">${createCircularProgressBar(progress.overall, colors[idx % colors.length])}<div class="absolute inset-0 flex items-center justify-center font-bold text-primary">${progress.overall.toFixed(0)}%</div></div><span class="font-semibold text-sm">${syllabusData[key].name}</span>`; btn.onclick = () => { state.activeSubject = key; renderAll(); }; fragment.appendChild(btn); }); container.innerHTML = ''; container.appendChild(fragment); }
        function renderProgressCards() { const subject = state.activeSubject;
            document.getElementById('selected-subject-main-progress').innerHTML = createBreakdownProgressBar(calculateProgress(subject, mainStudyItems), '‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á ‡¶ì ‡¶≤‡ßá‡¶ï‡¶ö‡¶æ‡¶∞') + createBreakdownProgressBar(calculateProgress(subject, revisionItems), '‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶®', ['rose', 'amber', 'lav']);
            document.getElementById('selected-subject-exam-progress').innerHTML = createBreakdownProgressBar(calculateProgress(subject, examItems), '‡¶∏‡¶ï‡¶≤ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ', ['peach', 'cyan', 'mint']);
            document.getElementById('selected-subject-qb-progress').innerHTML = createBreakdownProgressBar(calculateProgress(subject, ["MQB (Unmesh)"]), 'MQB (Unmesh)', ['amber', 'amber', 'amber']) + createBreakdownProgressBar(calculateProgress(subject, ["Retina QB"]), 'Retina QB', ['cyan', 'cyan', 'cyan']);
            const composite = calculateComposite(); document.getElementById('syllabus-total-container').innerHTML = createBreakdownProgressBar({ overall: composite.composite, paper1: 0, paper2: 0 }, 'Total Composite Score', ['lav', 'lav', 'lav']).replace(/‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞.*?<\/div>/, '').replace(/‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞.*?<\/div>/, '');
            const globalSummary = document.getElementById('global-summary-container'); globalSummary.innerHTML = `<div class="text-xs flex justify-between items-center"><span>Main Study</span> <strong class="font-bold">${composite.mainAvg.toFixed(1)}%</strong></div>${createProgressBar(composite.mainAvg, "mint")} <div class="text-xs flex justify-between items-center mt-2"><span>Revision</span> <strong class="font-bold">${composite.revAvg.toFixed(1)}%</strong></div>${createProgressBar(composite.revAvg, "sky")} <div class="text-xs flex justify-between items-center mt-2"><span>Exams</span> <strong class="font-bold">${composite.examAvg.toFixed(1)}%</strong></div>${createProgressBar(composite.examAvg, "peach")} <div class="text-xs flex justify-between items-center mt-2"><span>Question Banks</span> <strong class="font-bold">${composite.qbAvg.toFixed(1)}%</strong></div>${createProgressBar(composite.qbAvg, "amber")}`;
        }
        function renderSyllabusContent() { 
            const container = document.getElementById('syllabus-content'); if(!container) return; 
            const fragment = document.createDocumentFragment(); 
            const subjectKey = state.activeSubject; 
            const chaptersByPaper = syllabusData[subjectKey]?.chapters?.reduce((acc, chap) => { (acc[chap.paper] = acc[chap.paper] || []).push(chap); return acc; }, {}); 
            if(!chaptersByPaper) { container.innerHTML = 'No chapters found.'; return; } 
            
            const noteIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>`;
            const tickIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="black" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;

            Object.entries(chaptersByPaper).forEach(([paper, chapters]) => { 
                const details = document.createElement('details'); 
                details.open = state.syllabusOpenState[`${subjectKey}-${paper}`] !== false; 
                const paperProgress = calculateProgress(subjectKey, mainStudyItems); 
                const currentPaperProgress = (paper == 1) ? paperProgress.paper1 : paperProgress.paper2; 
                details.innerHTML = `<summary class="flex justify-between items-center p-3 border border-secondary rounded-lg mb-2 cursor-pointer transition-all hover:bg-main"><div class="font-bold flex items-center">${paper}‡¶Æ ‡¶™‡¶§‡ßç‡¶∞ <span class="text-sm font-normal text-muted ml-2">(${currentPaperProgress.toFixed(1)}%)</span> <span class="ml-2" data-info-btn-id="paper-${paper}-info-btn"></span></div><div class="w-1/3">${createProgressBar(currentPaperProgress, paper == 1 ? 'sky' : 'peach')}</div></summary>`; 
                const tableWrapper = document.createElement('div'); tableWrapper.className = 'overflow-x-auto'; 
                const table = document.createElement('table'); table.innerHTML = `<thead><tr><th class="w-1/4">‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü</th>${trackableItems.map(h => `<th class="text-center">${h}</th>`).join('')}</tr></thead>`; 
                const tbody = document.createElement('tbody'); 
                chapters.forEach(chapter => { 
                    const tr = document.createElement('tr'); 
                    let cells = `<td class="font-medium">${chapter.name}</td>`; 
                    trackableItems.forEach((item, i) => { 
                        const key = `s_${subjectKey}_${chapter.id}_${i}`; 
                        const status = Number(state.userData?.[key] ?? 0); 
                        const noteKey = `note_${key}`; 
                        const hasNote = !!state.userData?.[noteKey]; 
                        const fillNormalized = normalizeRawTo100(getRawPercentForStatus(status)); 
                        const isWon = Number(status) === 5; const isDone = Number(status) === 4;
                        cells += `<td class="text-center"><button class="task-status-btn ${isWon ? 'wont' : ''}" data-key="${key}" style="--fill:${fillNormalized}%"><span class="relative z-10 text-white font-bold text-xs">${isWon ? '‚úñ' : isDone ? tickIconSVG : ''}</span></button><button class="note-btn ${hasNote ? 'has-note' : ''} ml-2" data-key="${noteKey}" data-title="${chapter.name} - ${item}">${noteIconSVG}</button></td>`; 
                    }); 
                    tr.innerHTML = cells; 
                    tbody.appendChild(tr); 
                }); 
                table.appendChild(tbody); 
                tableWrapper.appendChild(table); 
                details.appendChild(tableWrapper); 
                fragment.appendChild(details); 
            }); 
            container.innerHTML = ''; 
            container.appendChild(fragment); 
            setupInfoButtons(); 
        }
        function renderAnalytics() { const container = document.getElementById('analytics-content'); if(!container) return; container.innerHTML = ''; const weakest = findWeakestSubject(); if(weakest) container.innerHTML += `<div class="mb-3"><p class="text-xs text-muted">Weakest Subject</p><p class="font-bold text-base text-red-500">${weakest.name} <span class="text-sm font-normal">(${weakest.score.toFixed(1)}%)</span></p></div>`; const timestamps = Object.entries(state.userData || {}).filter(([k]) => k.startsWith('timestamp_s_')).map(([k, v]) => ({ key: k.replace('timestamp_s_', ''), ts: new Date(v) })); if (!timestamps.length) { container.innerHTML += '<p class="text-muted text-xs">No activity data for chapter analysis.</p>'; return; } const chapterUpdates = {}; timestamps.forEach(({ key, ts }) => { const parts = key.split('_'); const chapKey = `${parts[0]}_${parts[1]}`; if (!chapterUpdates[chapKey] || ts > chapterUpdates[chapKey]) chapterUpdates[chapKey] = ts; }); const sorted = Object.entries(chapterUpdates).sort((a, b) => a[1] - b[1]); const leastTouched = sorted[0]; if (leastTouched) { const [chapKey, lastDate] = leastTouched; const [subject, chapId] = chapKey.split('_'); const chapInfo = syllabusData[subject]?.chapters.find(c => c.id == chapId); if (chapInfo) container.innerHTML += `<div><p class="text-xs text-muted">Least Studied Chapter</p><p class="font-bold text-base">${chapInfo.name}</p><p class="text-xs text-muted">(${syllabusData[subject].name}) - Last update: ${lastDate.toLocaleDateString()}</p></div>`; } }
        function setupInfoButtons() {
            const attach = (selector, data) => { const el = document.querySelector(selector); if(el) { el.innerHTML = ''; el.append(createInfoButton(data)); }};
            attach('#subject-choice-info-btn', {modalTitle: "Subject Choice", modalDesc: "‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á, ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ì ‡¶Æ‡ßá‡¶°‡¶ø‡¶ü‡ßç‡¶∞‡¶ø‡¶ï‡ßç‡¶∏ ‡¶è‡¶∞ ‡¶ó‡ßú ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", modalItems: mainStudyItems});
            attach('#main-progress-info-btn', {modalTitle: "Main Progress Calculation", modalDesc: "‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á ‡¶ì ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡ßá‡¶ï‡¶ö‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ó‡ßú ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡•§ ‡¶¨‡¶æ‡ßü‡ßã‡¶≤‡¶ú‡¶ø ‡¶ì ‡¶ï‡ßá‡¶Æ‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á ‡¶ì ‡¶Æ‡ßá‡¶°‡¶ø‡¶ü‡ßç‡¶∞‡¶ø‡¶ï‡ßç‡¶∏ ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö‡¶ü‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶´‡¶ø‡¶ú‡¶ø‡¶ï‡ßç‡¶∏‡ßá ‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á ‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡•§", modalItems: mainStudyItems.concat(revisionItems)});
            attach('#exam-progress-info-btn', {modalTitle: "Exam Progress Calculation", modalDesc: "‡¶∏‡¶ï‡¶≤ ‡¶ß‡¶∞‡¶£‡ßá‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ó‡ßú ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡•§", modalItems: examItems});
            attach('#qb-progress-info-btn', {modalTitle: "Question Bank Calculation", modalDesc: "‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶ó‡ßú ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡•§", modalItems: qbItems});
            attach('#composite-info-btn', {modalTitle: "Composite Score Calculation", modalDesc: "‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ Main Study, Revision, Exams, ‡¶è‡¶¨‡¶Ç Question Banks - ‡¶è‡¶á ‡¶ö‡¶æ‡¶∞‡¶ü‡¶ø ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡¶∞ ‡¶ó‡ßú‡•§", modalItems: ["Main Study Average", "Revision Average", "Exam Average", "QB Average"]});
            attach('#global-summary-info-btn', {modalTitle: "Global Summary", modalDesc: "‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶ö‡¶æ‡¶∞‡¶ü‡¶ø ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø‡¶§‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶ó‡ßú ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", modalItems: ["Global Main Study", "Global Revision", "Global Exams", "Global Question Banks"]});
            attach('#analytics-info-btn', {modalTitle: "Mini Analytics", modalDesc: "Weakest Subject: ‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá‡¶∞ ‡¶ó‡ßú ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶™‡¶ø‡¶õ‡¶ø‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶¨‡¶ø‡¶∑‡ßü‡•§ Least Studied: ‡¶Ø‡ßá ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡¶ü‡¶ø ‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶¨‡ßá‡¶∂‡¶ø‡¶¶‡¶ø‡¶® ‡¶ß‡¶∞‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§", modalItems: []});
            attach('[data-info-btn-id="paper-1-info-btn"]', {modalTitle: "‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø", modalDesc: "‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", modalItems: mainStudyItems});
            attach('[data-info-btn-id="paper-2-info-btn"]', {modalTitle: "‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø", modalDesc: "‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", modalItems: mainStudyItems});
        }
        
        let updateTimeout;
        const debouncedUpdate = (key, value) => { clearTimeout(updateTimeout); updateTimeout = setTimeout(() => updateState(key, value), 250); }; // Slightly shorter debounce
        async function updateState(key, value) { const dataKey = key.startsWith('userData.') ? key.substring(9) : null; if (!dataKey) return; state.userData[dataKey] = value; const writeData = { key: dataKey, value: value }; const writes = [writeData]; if (dataKey.startsWith('s_')) { const timestampKey = `timestamp_${dataKey}`; const timestampValue = new Date().toISOString().split('T')[0]; state.userData[timestampKey] = timestampValue; writes.push({ key: timestampKey, value: timestampValue }); } try { for(const write of writes) { await writeToDB('pendingWrites', write); } await writeToDB('userData', { id: 'main', value: state.userData }); document.getElementById('connection-status').textContent = 'Saved locally'; 
            // Fix 1: Only re-render progress bars, not the whole UI
            rerenderProgressBarsOnly();
            syncPendingWrites(); 
        } catch (e) { console.error("DB write failed:", e); showToast('‚ùå Local save failed!', 'error'); } }
        
        // --- Fix 1: Granular UI Update Function ---
        function rerenderProgressBarsOnly() {
            try {
                renderSubjectSelector(); // Re-render subject circles with potentially new percentages
                renderProgressCards(); // Re-render card progress bars
                renderAnalytics(); // Re-render analytics which depends on overall progress

                // Update paper progress bars inside the existing table without re-rendering it
                const subjectKey = state.activeSubject;
                const paperProgress = calculateProgress(subjectKey, mainStudyItems);
                
                const paper1Summary = document.querySelector(`details summary [data-info-btn-id="paper-1-info-btn"]`)?.closest('summary');
                if (paper1Summary) {
                    const progressDiv = paper1Summary.querySelector('.w-1\/3'); // Note: Escaped '/'
                    const percentSpan = paper1Summary.querySelector('.text-muted');
                    if (progressDiv) progressDiv.innerHTML = createProgressBar(paperProgress.paper1, 'sky');
                    if (percentSpan) percentSpan.textContent = `(${paperProgress.paper1.toFixed(1)}%)`;
                }

                const paper2Summary = document.querySelector(`details summary [data-info-btn-id="paper-2-info-btn"]`)?.closest('summary');
                 if (paper2Summary) {
                    const progressDiv = paper2Summary.querySelector('.w-1\/3'); // Note: Escaped '/'
                    const percentSpan = paper2Summary.querySelector('.text-muted');
                    if (progressDiv) progressDiv.innerHTML = createProgressBar(paperProgress.paper2, 'peach');
                    if (percentSpan) percentSpan.textContent = `(${paperProgress.paper2.toFixed(1)}%)`;
                }
            } catch (e) {
                console.error("Error during partial re-render:", e);
                // Fallback to full render if partial fails
                renderAll();
            }
        }

        async function syncPendingWrites() { const syncStatusEl = document.getElementById('connection-status'); if (!db || !userDocRef) { syncStatusEl.textContent = 'Firebase Error'; syncStatusEl.className = 'status-indicator offline'; return; } if (!navigator.onLine) { syncStatusEl.textContent = 'Offline'; syncStatusEl.className = 'status-indicator offline'; return; } const pending = await getAllFromDB('pendingWrites'); if (pending.length === 0) { const lastSynced = localStorage.getItem('lastSynced'); syncStatusEl.textContent = lastSynced ? `Synced: ${lastSynced}` : 'Synced'; syncStatusEl.className = 'status-indicator online'; return; } syncStatusEl.textContent = `Syncing...`; try { const batch = writeBatch(db); pending.forEach(item => batch.update(userDocRef, { [item.key]: item.value })); await batch.commit(); await clearDBStore('pendingWrites'); const now = new Date().toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }); localStorage.setItem('lastSynced', now); syncStatusEl.textContent = `Synced: ${now}`; syncStatusEl.className = 'status-indicator online'; showToast('‚úÖ Sync Successful!', 'success'); } catch (error) { console.error("Sync error: ", error); syncStatusEl.textContent = 'Sync Failed'; syncStatusEl.className = 'status-indicator offline'; showToast(`‚ùå Sync Failed! ${error.code || error.message}`, 'error');} }
        
        function showToast(message, type = 'success') { const t = document.createElement('div'); t.className = `px-4 py-2 rounded-lg shadow-lg ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white transition-all duration-300 transform opacity-0 translate-y-5`; t.textContent = message; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.classList.remove('opacity-0', 'translate-y-5'), 50); setTimeout(() => { t.classList.add('opacity-0', 'translate-y-5'); t.addEventListener('transitionend', () => t.remove()); }, 3000); }
        
        const noteModalOverlay = document.getElementById('note-modal-overlay');
        const noteModalTitle = document.getElementById('note-modal-title');
        const noteTextarea = document.getElementById('note-textarea');
        let currentNoteKey = null; let initialNoteValue = '';
        function openNoteModal(key, title) { currentNoteKey = key; initialNoteValue = state.userData?.[key] ?? ''; noteModalTitle.textContent = `Note for: ${title}`; noteTextarea.value = initialNoteValue; noteModalOverlay.classList.add('visible'); }
        function closeNoteModal() { noteModalOverlay.classList.remove('visible'); currentNoteKey = null; initialNoteValue = ''; }
        document.getElementById('note-modal-save').addEventListener('click', () => { if (currentNoteKey) { const newValue = noteTextarea.value; updateState(`userData.${currentNoteKey}`, newValue); const btn = document.querySelector(`.note-btn[data-key="${currentNoteKey}"]`); if(btn) btn.classList.toggle('has-note', !!newValue); } closeNoteModal(); });
        document.getElementById('note-modal-cancel').addEventListener('click', closeNoteModal);
        document.getElementById('note-modal-clear').addEventListener('click', () => noteTextarea.value = '');
        document.getElementById('note-modal-undo').addEventListener('click', () => noteTextarea.value = initialNoteValue);
        noteModalOverlay.addEventListener('click', e => { if (e.target === noteModalOverlay) closeNoteModal(); });

        function setupEventHandlers() {
            const infoModalOverlay = document.getElementById('info-modal-overlay');
            const tickIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="black" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
            document.body.addEventListener('click', e => {
                const targetBtn = e.target.closest('button'); if (!targetBtn) return;
                if (targetBtn.classList.contains('info-btn')) { const { modalTitle, modalDesc, modalItems } = targetBtn.dataset; document.getElementById('info-modal-title').textContent = modalTitle; document.getElementById('info-modal-desc').textContent = modalDesc; const itemsList = document.getElementById('info-modal-items'); itemsList.innerHTML = ''; try { if (modalItems && modalItems.length > 2) { JSON.parse(modalItems).forEach(item => { const li = document.createElement('li'); li.textContent = item; itemsList.appendChild(li); }); } } catch(err) {} infoModalOverlay.classList.add('visible'); return; }
                if (targetBtn.classList.contains('task-status-btn')) { 
                    const key = targetBtn.dataset.key;
                    const currentStatus = Number(state.userData?.[key] ?? 0);
                    const newStatus = (currentStatus + 1) % 6;
                    // --- Fix 1: Instant UI Update ---
                    const fill = normalizeRawTo100(getRawPercentForStatus(newStatus));
                    targetBtn.style.setProperty('--fill', `${fill}%`);
                    targetBtn.classList.toggle('wont', newStatus === 5);
                    const iconSpan = targetBtn.querySelector('span');
                    if (iconSpan) {
                         if (newStatus === 4) iconSpan.innerHTML = tickIconSVG; // 100%
                         else if (newStatus === 5) iconSpan.innerHTML = '‚úñ'; // Won't do
                         else iconSpan.innerHTML = ''; // Other states
                    }
                    debouncedUpdate(`userData.${key}`, newStatus); 
                    return; 
                }
                if (targetBtn.classList.contains('note-btn')) { openNoteModal(targetBtn.dataset.key, targetBtn.dataset.title); return; }
            });
            const closeInfoModal = () => infoModalOverlay.classList.remove('visible');
            infoModalOverlay.addEventListener('click', e => { if (e.target === infoModalOverlay) closeInfoModal(); });
            document.getElementById('info-modal-close').addEventListener('click', closeInfoModal);
            const syllabusContent = document.getElementById('syllabus-content');
            if (syllabusContent) { syllabusContent.addEventListener('toggle', (e) => { if (e.target.tagName === 'DETAILS') state.syllabusOpenState[`${state.activeSubject}-${e.target.textContent.includes('‡ßß‡¶Æ') ? 1 : 2}`] = e.target.open; }, true); }
        }
        let countdownInterval;
        function startCountdown() { if(countdownInterval) clearInterval(countdownInterval); const target = new Date('2025-12-12T00:00:00+06:00'); const countdownEl = document.getElementById('countdown'); if(!countdownEl) return; const tick = () => { const diff = Math.max(0, target - new Date()); const d = Math.floor(diff / 864e5), h = Math.floor((diff % 864e5) / 36e5), m = Math.floor((diff % 36e5) / 6e4), s = Math.floor((diff % 6e4) / 1e3); countdownEl.innerHTML = `<div class="text-center"><div class="countdown-num">${d}</div><div class="countdown-label">‡¶¶‡¶ø‡¶®</div></div><div class="text-center"><div class="countdown-num">${String(h).padStart(2,'0')}</div><div class="countdown-label">‡¶ò‡¶£‡ßç‡¶ü‡¶æ</div></div><div class="text-center"><div class="countdown-num">${String(m).padStart(2,'0')}</div><div class="countdown-label">‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü</div></div><div class="text-center"><div class="countdown-num">${String(s).padStart(2,'0')}</div><div class="countdown-label">‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°</div></div>`; }; tick(); countdownInterval = setInterval(tick, 1000); }
        function setupThemeToggle() { const btn = document.getElementById('theme-toggle-btn'); const meta = document.getElementById('theme-color-meta'); const applyTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'; meta.content = theme === 'dark' ? '#1c1c1c' : '#f8f7f2'; }; btn.addEventListener('click', () => { const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; localStorage.setItem('theme', newTheme); applyTheme(newTheme); }); applyTheme(localStorage.getItem('theme') || 'dark'); }
        function setupViewToggle() { const btn = document.getElementById('view-toggle-btn'); const viewportMeta = document.querySelector('meta[name="viewport"]'); const applyView = (mode) => { if (mode === 'desktop') { viewportMeta.setAttribute('content', 'width=1280, initial-scale=1'); document.body.classList.add('desktop-view'); } else { viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.0'); document.body.classList.remove('desktop-view'); } }; btn.addEventListener('click', () => { const newMode = document.body.classList.contains('desktop-view') ? 'mobile' : 'desktop'; localStorage.setItem('viewMode', newMode); applyView(newMode); }); applyView(localStorage.getItem('viewMode') || 'mobile'); }
        
        // --- Render Function ---
        function renderAll() { 
            try {
                renderSubjectSelector(); 
                renderProgressCards(); 
                renderSyllabusContent(); 
                renderAnalytics(); 
            } catch (e) {
                console.error("RenderAll failed:", e);
                // Optionally display a user-friendly error message on the page
            }
        }
        
        // --- App Initialization ---
        async function startApp() {
            const syncStatusEl = document.getElementById('connection-status');
            syncStatusEl.textContent = 'Initializing...';
            setupViewToggle();
            try { await openDB(); } catch(e) { console.error("Failed to open IndexedDB:", e); syncStatusEl.textContent = 'DB Error'; }
            try { syncStatusEl.textContent = 'Loading cache...'; const cachedData = await getFromDB('userData', 'main'); if (cachedData) { state.userData = cachedData.value || {}; } } catch (e) { console.error("Cache load failed", e); }
            if(db) { syncStatusEl.textContent = 'Connecting...'; try { onSnapshot(userDocRef, (snap) => { if (snap.exists()) { const firestoreData = snap.data(); state.userData = { ...(state.userData || {}), ...firestoreData }; writeToDB('userData', { id: 'main', value: state.userData }); renderAll(); } syncPendingWrites(); }, (error) => { console.error("Firestore error:", error); syncStatusEl.textContent = 'Sync Failed'; syncStatusEl.className = 'status-indicator offline'; }); } catch(e) { console.error("onSnapshot failed:", e); syncStatusEl.textContent = 'Firebase Error'; syncStatusEl.className = 'status-indicator offline';}
            } else { syncStatusEl.textContent = 'Firebase Failed'; syncStatusEl.className = 'status-indicator offline'; }
            renderAll();
            setupEventHandlers();
            setupInfoButtons();
            startCountdown();
            setupThemeToggle();
            document.getElementById('force-sync-btn').addEventListener('click', syncPendingWrites);
            window.addEventListener('online', syncPendingWrites); window.addEventListener('offline', () => { syncStatusEl.textContent = 'Offline'; syncStatusEl.className = 'status-indicator offline'; });
            syncPendingWrites();
            window.addEventListener('beforeunload', () => clearInterval(countdownInterval));
        }
        startApp();
    </script>
</body>
</html>        tbody td { padding: 10px; border-bottom: 1px solid var(--border-secondary); vertical-align: top; font-size: 14px; transition: border-color 0.3s; }
        .progress-bar-container { background-color: var(--progress-track); border-radius: 9999px; overflow: hidden; height: 26px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.1); border: 1px solid var(--border-secondary); }
        .progress-bar-container.h-4 { height: 1rem; }
        .progress-bar { height: 100%; border-radius: 9999px; transition: width 0.45s ease-in-out; text-align: center; font-weight: 700; color: var(--progress-text); font-size: 13px; line-height: 26px; box-shadow: 0 2px 6px rgba(0,0,0,0.06) inset; }
        .h-4 .progress-bar { line-height: 1rem; }
        .pb-mint { background: linear-gradient(90deg,#6ee7b7,#34d399); } .pb-sky { background: linear-gradient(90deg,#7dd3fc,#38bdf8); } .pb-peach { background: linear-gradient(90deg,#fb923c,#f97316); } .pb-lav { background: linear-gradient(90deg,#c4b5fd,#a78bfa); } .pb-red { background: linear-gradient(90deg,#f87171,#ef4444); }
        .task-status-btn { --fill: 0%; position: relative; display:inline-flex; align-items:center; justify-content:center; width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--circle-border); background: transparent; cursor: pointer; overflow: hidden; padding:0; z-index: 1; transition: transform .08s ease, border-color .12s; color: transparent; font-weight:700; user-select:none; }
        .task-status-btn::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: var(--fill, 0%); background: linear-gradient(90deg,#a8f0da,#4be6b1); z-index: 0; transition: width .25s ease; }
        .task-status-btn:hover { transform: translateY(-2px); border-color: #9ca3af; }
        .task-status-btn.wont { background: #ef4444; border-color: #991b1b; color: #fff !important; }
        .note-btn { background: var(--note-btn-bg); color: var(--note-btn-text); border: 1px solid var(--note-btn-border); border-radius: 8px; padding:6px; cursor:pointer; font-size:13px; }
        .note-btn.has-note { background: var(--note-btn-active-bg); color: var(--note-btn-active-text); border-color: var(--note-btn-active-bg); }
        #countdown { background: linear-gradient(135deg, #d90429, #ef233c); color: #fff; padding: 16px 24px; border-radius: 16px; box-shadow: 0 12px 32px rgba(217, 4, 41, 0.3); display:flex; flex-direction:column; align-items:center; gap:10px; }
        #countdown .countdown-grid { display:flex; gap:16px; }
        .countdown-col { background: rgba(255,255,255,0.15); padding:12px 18px; border-radius:10px; text-align:center; min-width:80px; }
        .countdown-num { font-weight:800; font-size:28px; line-height:1.1; }
        .countdown-label { font-size:14px; opacity:0.95; margin-top: 4px; }
        #countdown small { font-size:13px; color: #ffecec; font-weight:600; }
        #theme-toggle { cursor: pointer; font-size: 24px; padding: 8px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border-secondary); }
        #connection-status { font-size: 13px; font-weight: 600; padding: 6px 12px; border-radius: 8px; user-select: none; }
        #connection-status.online { background-color: #166534; color: #dcfce7; }
        #connection-status.offline { background-color: #991b1b; color: #fee2e2; }
        .container { max-width:1200px; margin:0 auto; } .small-muted { color: var(--text-muted); font-size:13px; } .text-muted { color: var(--text-muted); }
    </style>
</head>
<body>
    <header class="sticky top-0 z-30">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center; padding:12px 18px;">
            <div style="display:flex; align-items:center; gap:16px;"><h1 class="text-xl font-bold">‡¶∏‡ßç‡¶ü‡¶æ‡¶°‡¶ø ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1><div id="connection-status">Connecting...</div></div>
            <div id="countdown"><div class="countdown-grid"><div class="countdown-col"><div class="countdown-num" id="days">0</div><div class="countdown-label">‡¶¶‡¶ø‡¶®</div></div><div class="countdown-col"><div class="countdown-num" id="hours">00</div><div class="countdown-label">‡¶ò‡¶£‡ßç‡¶ü‡¶æ</div></div><div class="countdown-col"><div class="countdown-num" id="minutes">00</div><div class="countdown-label">‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü</div></div><div class="countdown-col"><div class="countdown-num" id="seconds">00</div><div class="countdown-label">‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°</div></div></div><small>(Last Timer)</small></div>
            <div style="display:flex; align-items:center; gap: 12px;"><button id="theme-toggle" title="Change theme">üåô</button></div>
        </div>
    </header>

    <main id="app-container" class="container" style="padding:22px;">
        <section id="syllabus-shell" class="card">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
                <h2 style="font-size:20px; font-weight:700;">‡¶∏‡¶ø‡¶≤‡ßá‡¶¨‡¶æ‡¶∏ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø</h2><div id="sync-status" class="small-muted">Loading data...</div>
            </div>
             <div style="display:flex; gap:24px;">
                <div style="flex:1;"><div style="margin-bottom:14px;"><h3 style="font-weight:700; margin-bottom:8px;">‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</h3><div id="subject-selector" style="display:flex; gap:8px;"></div></div><div id="overall-progress-container" style="margin-top:18px"></div><div id="revision-progress-container" style="margin-top:18px"></div><div id="exam-progress-container" style="margin-top:18px"></div></div>
                <div style="flex:1;"><h3 style="font-weight:700; margin-bottom:8px;">‡¶∏‡¶æ‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</h3><div id="subjects-summary" style="display:flex; flex-direction:column; gap:12px;"></div><div style="margin-top:18px;"><h3 style="font-weight:700; margin-bottom:8px;">‡¶∏‡¶æ‡¶Æ‡¶ó‡ßç‡¶∞‡¶ø‡¶ï ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®</h3><div id="syllabus-total-container"></div></div></div>
            </div>
            <div id="syllabus-content" style="margin-top:18px;"></div>
        </section>
    </main>
    <div id="toast-container" style="position:fixed; right:16px; bottom:18px; z-index:60;"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- All JavaScript code is exactly the same as the last version ---
        // I'm keeping it here for completeness. The logic for both features is already inside.

        const firebaseConfig = {"apiKey":"AIzaSyDTLhIkrW9qk6KPT_gTDibIiJeVwWYTowk","authDomain":"my-study-dashboard.firebaseapp.com","projectId":"my-study-dashboard","storageBucket":"my-study-dashboard.appspot.com","messagingSenderId":"66307909031","appId":"1:66307909031:web:9e724a43c8c11a0ef80282"};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const userDocRef = doc(db, "users", "as19", "progress", "main");
        const DB_NAME = 'StudyDashboardDB_v2'; const DB_VERSION = 1; let idb;
        function openDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = () => reject("Error opening IndexedDB."); request.onsuccess = (event) => { idb = event.target.result; resolve(idb); }; request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains('userData')) db.createObjectStore('userData', { keyPath: 'id' }); if (!db.objectStoreNames.contains('pendingWrites')) db.createObjectStore('pendingWrites', { autoIncrement: true }); }; }); }
        async function getFromDB(storeName, key) { if (!idb) await openDB(); return new Promise((resolve, reject) => { const tx = idb.transaction(storeName, 'readonly'); tx.onerror = () => reject(tx.error); const store = tx.objectStore(storeName); const request = store.get(key); request.onsuccess = () => resolve(request.result); }); }
        async function getAllFromDB(storeName) { if (!idb) await openDB(); return new Promise((resolve, reject) => { const tx = idb.transaction(storeName, 'readonly'); tx.onerror = () => reject(tx.error); const store = tx.objectStore(storeName); const request = store.getAll(); request.onsuccess = () => resolve(request.result); }); }
        async function writeToDB(storeName, data) { if (!idb) await openDB(); return new Promise((resolve, reject) => { const tx = idb.transaction(storeName, 'readwrite'); tx.oncomplete = () => resolve(); tx.onerror = () => reject(tx.error); const store = tx.objectStore(storeName); store.put(data); }); }
        async function clearDBStore(storeName) { if (!idb) await openDB(); return new Promise((resolve, reject) => { const tx = idb.transaction(storeName, 'readwrite'); tx.oncomplete = () => resolve(); tx.onerror = () => reject(tx.error); const store = tx.objectStore(storeName); store.clear(); }); }
        const state = { userData: {}, activeSubject: 'biology', syllabusOpenState: {} };
        const syncStatusEl = document.getElementById('sync-status');
        const syllabusData = { biology: { name: "‡¶ú‡ßÄ‡¶¨‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", chapters: [ { id: 1, name: "‡¶ï‡ßã‡¶∑ ‡¶ì ‡¶è‡¶∞ ‡¶ó‡¶†‡¶®", paper: 1 }, { id: 2, name: "‡¶ï‡ßã‡¶∑ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ú‡¶®", paper: 1 }, { id: 3, name: "‡¶ï‡ßã‡¶∑ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 1 }, { id: 4, name: "‡¶Ö‡¶£‡ßÅ‡¶ú‡ßÄ‡¶¨", paper: 1 }, { id: 5, name: "‡¶∂‡ßà‡¶¨‡¶æ‡¶≤ ‡¶ì ‡¶õ‡¶§‡ßç‡¶∞‡¶æ‡¶ï", paper: 1 }, { id: 6, name: "‡¶¨‡ßç‡¶∞‡¶æ‡¶Ø‡¶º‡ßã‡¶´‡¶æ‡¶á‡¶ü‡¶æ ‡¶ì ‡¶ü‡ßá‡¶∞‡¶ø‡¶°‡ßã‡¶´‡¶æ‡¶á‡¶ü‡¶æ", paper: 1 }, { id: 7, name: "‡¶®‡¶ó‡ßç‡¶®‡¶¨‡ßÄ‡¶ú‡¶ø ‡¶ì ‡¶Ü‡¶¨‡ßÉ‡¶§‡¶¨‡ßÄ‡¶ú‡¶ø ‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶", paper: 1 }, { id: 8, name: "‡¶ü‡¶ø‡¶∏‡ßç‡¶Ø‡ßÅ ‡¶ì ‡¶ü‡¶ø‡¶∏‡ßç‡¶Ø‡ßÅ‡¶§‡¶®‡ßç‡¶§‡ßç‡¶∞", paper: 1 }, { id: 9, name: "‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨", paper: 1 }, { id: 10, name: "‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶ ‡¶™‡ßç‡¶∞‡¶ú‡¶®‡¶®", paper: 1 }, { id: 11, name: "‡¶ú‡ßÄ‡¶¨ ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø", paper: 1 }, { id: 12, name: "‡¶ú‡ßÄ‡¶¨‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂, ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞ ‡¶ì ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£", paper: 1 }, { id: 13, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶¨‡ßà‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡ßç‡¶Ø ‡¶ì ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø‡¶¨‡¶ø‡¶®‡ßç‡¶Ø‡¶æ‡¶∏", paper: 2 }, { id: 14, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø (‡¶π‡¶æ‡¶á‡¶°‡ßç‡¶∞‡¶æ)", paper: 2 }, { id: 15, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø (‡¶ò‡¶æ‡¶∏‡¶´‡¶°‡¶º‡¶ø‡¶Ç)", paper: 2 }, { id: 16, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø (‡¶∞‡ßÅ‡¶á ‡¶Æ‡¶æ‡¶õ)", paper: 2 }, { id: 17, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶™‡¶∞‡¶ø‡¶™‡¶æ‡¶ï ‡¶ì ‡¶∂‡ßã‡¶∑‡¶£", paper: 2 }, { id: 18, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶∞‡¶ï‡ßç‡¶§ ‡¶ì ‡¶∏‡¶û‡ßç‡¶ö‡¶æ‡¶≤‡¶®", paper: 2 }, { id: 19, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ì ‡¶∂‡ßç‡¶¨‡¶∏‡¶®", paper: 2 }, { id: 20, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶¨‡¶∞‡ßç‡¶ú‡ßç‡¶Ø ‡¶ì ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∂‡¶®", paper: 2 }, { id: 21, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶ö‡¶≤‡¶® ‡¶ì ‡¶Ö‡¶ô‡ßç‡¶ó‡¶ö‡¶æ‡¶≤‡¶®‡¶æ", paper: 2 }, { id: 22, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶∂‡¶∞‡ßÄ‡¶∞‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨: ‡¶∏‡¶Æ‡¶®‡ßç‡¶¨‡¶Ø‡¶º ‡¶ì ‡¶®‡¶ø‡¶Ø‡¶º‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£", paper: 2 }, { id: 23, name: "‡¶Æ‡¶æ‡¶®‡¶¨ ‡¶ú‡ßÄ‡¶¨‡¶®‡ßá‡¶∞ ‡¶ß‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶ø‡¶ï‡¶§‡¶æ", paper: 2 }, { id: 24, name: "‡¶Æ‡¶æ‡¶®‡¶¨‡¶¶‡ßá‡¶π‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∞‡¶ï‡ßç‡¶∑‡¶æ", paper: 2 }, { id: 25, name: "‡¶ú‡¶ø‡¶®‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨ ‡¶ì ‡¶¨‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®", paper: 2 }, { id: 26, name: "‡¶™‡ßç‡¶∞‡¶æ‡¶£‡¶ø‡¶∞ ‡¶Ü‡¶ö‡¶∞‡¶£", paper: 2 } ] }, chemistry: { name: "‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", chapters: [ { id: 1, name: "‡¶≤‡ßç‡¶Ø‡¶æ‡¶¨‡¶∞‡ßá‡¶ü‡¶∞‡¶ø‡¶∞ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞", paper: 1 }, { id: 2, name: "‡¶ó‡ßÅ‡¶£‡¶ó‡¶§ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 1 }, { id: 3, name: "‡¶Æ‡ßå‡¶≤‡ßá‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡¶¨‡ßÉ‡¶§‡ßç‡¶§ ‡¶ß‡¶∞‡ßç‡¶Æ ‡¶ì ‡¶∞‡¶æ‡¶∏‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶ß‡¶®", paper: 1 }, { id: 4, name: "‡¶∞‡¶æ‡¶∏‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®", paper: 1 }, { id: 5, name: "‡¶ï‡¶∞‡ßç‡¶Æ‡¶Æ‡ßÇ‡¶ñ‡ßÄ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 1 }, { id: 6, name: "‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 7, name: "‡¶ú‡ßà‡¶¨ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 8, name: "‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£‡¶ó‡¶§ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 9, name: "‡¶§‡¶°‡¶º‡¶ø‡ßé ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 }, { id: 10, name: "‡¶Ö‡¶∞‡ßç‡¶•‡¶®‡ßà‡¶§‡¶ø‡¶ï ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®", paper: 2 } ] }, physics: { name: "‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", chapters: [ { id: 1, name: "‡¶≠‡ßå‡¶§ ‡¶ú‡¶ó‡¶§ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™", paper: 1 }, { id: 2, name: "‡¶≠‡ßá‡¶ï‡ßç‡¶ü‡¶∞", paper: 1 }, { id: 3, name: "‡¶ó‡¶§‡¶ø‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ", paper: 1 }, { id: 4, name: "‡¶®‡¶ø‡¶â‡¶ü‡¶®‡¶ø‡¶Ø‡¶º‡¶æ‡¶® ‡¶¨‡¶≤‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ", paper: 1 }, { id: 5, name: "‡¶ï‡¶æ‡¶ú, ‡¶∂‡¶ï‡ßç‡¶§‡¶ø ‡¶ì ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ", paper: 1 }, { id: 6, name: "‡¶Æ‡¶π‡¶æ‡¶ï‡¶∞‡ßç‡¶∑ ‡¶ì ‡¶Ö‡¶≠‡¶ø‡¶ï‡¶∞‡ßç‡¶∑", paper: 1 }, { id: 7, name: "‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡ßá‡¶∞ ‡¶ó‡¶æ‡¶†‡¶®‡¶ø‡¶ï ‡¶ß‡¶∞‡ßç‡¶Æ", paper: 1 }, { id: 8, name: "‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶ó‡¶§‡¶ø", paper: 1 }, { id: 9, name: "‡¶§‡¶∞‡¶ô‡ßç‡¶ó", paper: 1 }, { id: 10, name: "‡¶Ü‡¶¶‡¶∞‡ßç‡¶∂ ‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏ ‡¶ì ‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ó‡¶§‡¶ø‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨", paper: 1 }, { id: 11, name: "‡¶§‡¶æ‡¶™‡¶ó‡¶§‡¶ø‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ", paper: 2 }, { id: 12, name: "‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶§‡¶°‡¶º‡¶ø‡ßé", paper: 2 }, { id: 13, name: "‡¶ö‡¶≤ ‡¶§‡¶°‡¶º‡¶ø‡ßé", paper: 2 }, { id: 14, name: "‡¶§‡¶°‡¶º‡¶ø‡ßé ‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶π‡ßá‡¶∞ ‡¶ö‡ßå‡¶Æ‡ßç‡¶¨‡¶ï ‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ì ‡¶ö‡ßÅ‡¶Æ‡ßç‡¶¨‡¶ï‡¶§‡ßç‡¶¨", paper: 2 }, { id: 15, name: "‡¶§‡¶°‡¶º‡¶ø‡ßé ‡¶ö‡ßå‡¶Æ‡ßç‡¶¨‡¶ï ‡¶Ü‡¶¨‡ßá‡¶∂ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡ßç‡¶∞‡¶¨‡¶æ‡¶π", paper: 2 }, { id: 16, name: "‡¶ú‡ßç‡¶Ø‡¶æ‡¶Æ‡¶ø‡¶§‡¶ø‡¶ï ‡¶Ü‡¶≤‡ßã‡¶ï‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", paper: 2 }, { id: 17, name: "‡¶≠‡ßå‡¶§ ‡¶Ü‡¶≤‡ßã‡¶ï‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ", paper: 2 }, { id: 18, name: "‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡ßÇ‡¶ö‡¶®‡¶æ", paper: 2 }, { id: 19, name: "‡¶™‡¶∞‡¶Æ‡¶æ‡¶£‡ßÅ‡¶∞ ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶â‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", paper: 2 }, { id: 20, name: "‡¶∏‡ßá‡¶Æ‡¶ø‡¶ï‡¶®‡ßç‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡¶∞ ‡¶ì ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡¶∏", paper: 2 }, { id: 21, name: "‡¶ú‡ßç‡¶Ø‡ßã‡¶§‡¶ø‡¶∞‡ßç‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®", paper: 2 } ] } };
        async function syncPendingWrites() { if (!navigator.onLine) return; const pending = await getAllFromDB('pendingWrites'); if (pending.length === 0) { syncStatusEl.textContent = 'Synced with Firebase'; return; } syncStatusEl.textContent = `Syncing ${pending.length} changes...`; try { const batch = writeBatch(db); const updates = {}; pending.forEach(item => { updates[item.key] = item.value; }); batch.update(userDocRef, updates); await batch.commit(); await clearDBStore('pendingWrites'); showToast(`‚úÖ ${pending.length}‡¶ü‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® Sync ‡¶π‡ßü‡ßá‡¶õ‡ßá!`, 'success'); syncStatusEl.textContent = 'Synced with Firebase'; } catch (error) { console.error("Error syncing pending writes: ", error); syncStatusEl.textContent = 'Sync failed. Retrying later.'; showToast('‚ùå Sync ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü ‡¶®‡¶ø', 'error'); } }
        async function updateState(key, value) { const dataKey = key.startsWith('userData.') ? key.substring(9) : null; if (dataKey) { state.userData[dataKey] = value; try { await writeToDB('pendingWrites', { key: dataKey, value: value }); await writeToDB('userData', { id: 'main', value: state.userData }); syncStatusEl.textContent = 'Saved locally.'; renderAll(); syncPendingWrites(); } catch (e) { console.error("Failed to write to DB:", e); } } else { const keys = key.split('.'); let current = state; for (let i = 0; i < keys.length - 1; i++) { current = current[keys[i]] = current[keys[i]] || {}; } current[keys[keys.length - 1]] = value; } }
        const trackableItems = ["‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á", "Class", "Meditrics", "MQB (Unmesh)", "Retina QB", "Secret Files Exam", "Daily Exam", "Weekly Exam", "Campus Exam", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ßß", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ß®"]; const mainStudyItems = ["‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á", "Class", "Meditrics", "MQB (Unmesh)", "Retina QB"]; const examItems = ["Secret Files Exam", "Daily Exam", "Weekly Exam", "Campus Exam"]; const revisionItems = ["‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ßß", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡ß®"];
        function getRawPercentForStatus(status) { if (typeof status !== 'number') status = Number(status) || 0; return (status >= 0 && status <= 4) ? status * 20 : 0; }
        function isWont(status) { return Number(status) === 5; }
        function normalizeRawTo100(raw) { return raw <= 0 ? 0 : Math.min(100, (raw / 80) * 100); }
        function calculateProgress(subjectKey, itemsToCount) { const subjectData = syllabusData[subjectKey]; if (!subjectData) return { overall: 0, paper1: 0, paper2: 0 }; const itemIndices = itemsToCount.map(item => trackableItems.indexOf(item)).filter(i => i >= 0); let totalNormalizedSum = 0, totalChaps = subjectData.chapters.length, p1Sum = 0, p1Count = 0, p2Sum = 0, p2Count = 0; subjectData.chapters.forEach(ch => { let rawSum = 0; itemIndices.forEach(i => { rawSum += getRawPercentForStatus(state.userData[`s_${subjectKey}_${ch.id}_${i}`]); }); const normalized = normalizeRawTo100(itemIndices.length > 0 ? rawSum / itemIndices.length : 0); totalNormalizedSum += normalized; if (ch.paper === 1) { p1Sum += normalized; p1Count++; } else { p2Sum += normalized; p2Count++; } }); return { overall: totalChaps > 0 ? totalNormalizedSum / totalChaps : 0, paper1: p1Count > 0 ? p1Sum / p1Count : 0, paper2: p2Count > 0 ? p2Sum / p2Count : 0 }; }
        function calculateSubjectOverall(subjectKey) { return calculateProgress(subjectKey, mainStudyItems).overall; }
        function calculateExamProgress(subjectKey) { return calculateProgress(subjectKey, examItems); }
        function calculateRevisionProgress(subjectKey) { return calculateProgress(subjectKey, revisionItems); }
        function calculateComposite() { const subjects = Object.keys(syllabusData); const subjectsAvg = subjects.reduce((sum, s) => sum + calculateSubjectOverall(s), 0) / subjects.length; const examsAvg = subjects.reduce((sum, s) => sum + calculateExamProgress(s).overall, 0) / subjects.length; const revisionsAvg = subjects.reduce((sum, s) => sum + calculateRevisionProgress(s).overall, 0) / subjects.length; return { subjectsAvg, examsAvg, revisionsAvg, composite: (subjectsAvg + examsAvg + revisionsAvg) / 3 }; }
        function createProgressBarHTML(progress, variant, small) { const p = Math.max(0, Math.min(100, progress || 0)); const cls = { 'mint': 'pb-mint', 'sky': 'pb-sky', 'peach': 'pb-peach', 'lav': 'pb-lav', 'red': 'pb-red' }[variant] || 'pb-mint'; const gradient = `linear-gradient(90deg, ${cls === 'pb-mint' ? '#6ee7b7, #34d399' : cls === 'pb-sky' ? '#7dd3fc, #38bdf8' : cls === 'pb-peach' ? '#fb923c, #f97316' : '#c4b5fd, #a78bfa'})`; return `<div class="progress-bar-container ${small ? 'h-4' : ''}"><div class="progress-bar" style="width:${p.toFixed(1)}%; background-image:${gradient};">${!small ? p.toFixed(1)+'%' : ''}</div></div>`; }
        function showToast(message, type = 'success') { const t = document.createElement('div'); t.className = `px-4 py-2 rounded-lg shadow-lg ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white transition-all duration-300 transform opacity-0 translate-y-5`; t.textContent = message; document.getElementById('toast-container').appendChild(t); setTimeout(() => { t.style.opacity = '1'; t.style.transform = 'translateY(0)'; }, 50); setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(20px)'; setTimeout(() => t.remove(), 300); }, 2500); }
        function renderSubjectSelector() { const container = document.getElementById('subject-selector'); container.innerHTML = ''; Object.keys(syllabusData).forEach(key => { const btn = document.createElement('button'); const isActive = state.activeSubject === key; btn.className = `px-3 py-2 rounded-lg text-sm font-semibold transition-all`; btn.style.background = isActive ? 'var(--subject-btn-active-bg)' : 'var(--bg-card)'; btn.style.color = isActive ? 'var(--subject-btn-active-text)' : 'var(--text-primary)'; btn.style.border = '1px solid ' + (isActive ? 'var(--subject-btn-active-bg)' : 'var(--border-primary)'); btn.dataset.subject = key; btn.textContent = syllabusData[key].name; btn.onclick = () => { state.activeSubject = key; renderAll(); }; container.appendChild(btn); }); }
        function renderSubjectsSummary() { const container = document.getElementById('subjects-summary'); container.innerHTML = ''; Object.keys(syllabusData).forEach((key, idx) => { const sDiv = document.createElement('div'); sDiv.className = 'p-3 rounded-lg border'; sDiv.style.background = 'var(--bg-card)'; sDiv.style.borderColor = 'var(--border-secondary)'; const subjName = syllabusData[key].name; const subjProg = calculateSubjectOverall(key); const examProg = calculateExamProgress(key).overall; const revProg = calculateRevisionProgress(key).overall; const variants = ['mint', 'sky', 'peach']; sDiv.innerHTML = `<div class="flex justify-between items-center mb-2"><strong class="text-sm">${subjName}</strong><span class="text-xs text-muted">${subjProg.toFixed(1)}%</span></div>${createProgressBarHTML(subjProg, variants[idx % variants.length], true)}<div class="text-xs text-muted mt-2">Exam: ${examProg.toFixed(1)}% | Revision: ${revProg.toFixed(1)}%</div>`; container.appendChild(sDiv); }); }
        function renderSummaryBars() { const total = calculateComposite(); document.getElementById('syllabus-total-container').innerHTML = `<div class="text-xs text-muted mb-2">Subjects: ${total.subjectsAvg.toFixed(1)}% | Exams: ${total.examsAvg.toFixed(1)}% | Revisions: ${total.revisionsAvg.toFixed(1)}%</div>${createProgressBarHTML(total.composite, 'lav', false)}`; document.getElementById('overall-progress-container').innerHTML = `<div class="font-bold mb-2 text-sm">‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶á/‡¶≤‡ßá‡¶ï‡¶ö‡¶æ‡¶∞</div>` + createProgressBarHTML(calculateSubjectOverall(state.activeSubject), 'mint', false); document.getElementById('exam-progress-container').innerHTML = `<div class="font-bold mb-2 text-sm">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø</div>` + createProgressBarHTML(calculateExamProgress(state.activeSubject).overall, 'peach', false); document.getElementById('revision-progress-container').innerHTML = `<div class="font-bold mb-2 text-sm">‡¶∞‡¶ø‡¶≠‡¶ø‡¶∂‡¶® ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø</div>` + createProgressBarHTML(calculateRevisionProgress(state.activeSubject).overall, 'sky', false); }
        
        function renderSyllabusContent() {
            const container = document.getElementById('syllabus-content'); container.innerHTML = ''; const subjectKey = state.activeSubject; const chaptersByPaper = syllabusData[subjectKey].chapters.reduce((acc, chap) => { (acc[chap.paper] = acc[chap.paper] || []).push(chap); return acc; }, {}); const paperProgress = calculateProgress(subjectKey, mainStudyItems);
            Object.entries(chaptersByPaper).forEach(([paper, chapters]) => {
                const details = document.createElement('details'); details.open = state.syllabusOpenState[`${subjectKey}-${paper}`] !== false; const currentPaperProgress = (paper == 1) ? paperProgress.paper1 : paperProgress.paper2; const percentageText = `(${currentPaperProgress.toFixed(1)}%)`;
                
                // This is the line that adds the percentage
                details.innerHTML = `<summary class="p-2 flex justify-between items-center border border-secondary rounded-lg mb-2 cursor-pointer"><div class="font-bold">${paper}‡¶Æ ‡¶™‡¶§‡ßç‡¶∞ <span class="text-sm font-normal text-muted">${percentageText}</span></div><div id="paper-progress-${subjectKey}-${paper}" style="width:36%"></div></summary>`;
                
                const table = document.createElement('table'); table.innerHTML = `<thead><tr><th>‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü</th>${trackableItems.map(h => `<th class="text-center">${h}</th>`).join('')}</tr></thead>`; const tbody = document.createElement('tbody');
                chapters.forEach(chapter => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="w-1/3">${chapter.name}</td>`; trackableItems.forEach((item, i) => { const key = `s_${subjectKey}_${chapter.id}_${i}`; const status = Number(state.userData[key] ?? 0); const noteKey = `note_${key}`; const hasNote = !!state.userData[noteKey]; const fillNormalized = normalizeRawTo100(getRawPercentForStatus(status)); const isWon = isWont(status); tr.innerHTML += `<td class="text-center"><button class="task-status-btn ${isWon ? 'wont' : ''}" data-key="${key}" style="--fill:${fillNormalized}%">${isWon ? '‚úñ' : ''}</button><button class="note-btn ${hasNote ? 'has-note' : ''} ml-2" data-key="${noteKey}" data-title="${chapter.name} - ${item}">${hasNote ? 'üóíÔ∏è' : 'üìù'}</button></td>`; }); tbody.appendChild(tr); }); table.appendChild(tbody); details.appendChild(table); container.appendChild(details);
            });
            const p1ProgressContainer = document.getElementById(`paper-progress-${subjectKey}-1`); if (p1ProgressContainer) p1ProgressContainer.innerHTML = createProgressBarHTML(paperProgress.paper1, 'sky', true); const p2ProgressContainer = document.getElementById(`paper-progress-${subjectKey}-2`); if (p2ProgressContainer) p2ProgressContainer.innerHTML = createProgressBarHTML(paperProgress.paper2, 'peach', true);
        }
        function openNoteModal(key, title) { const modal = document.createElement('div'); modal.style.cssText = 'position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1000; background:rgba(8,6,6,0.6); backdrop-filter:blur(4px);'; modal.innerHTML = `<div class="w-11/12 max-w-2xl p-5 rounded-lg shadow-xl" style="background:var(--bg-card); color:var(--text-primary);"><h3 class="font-bold mb-3">${title}</h3><textarea id="note-text" class="w-full h-48 p-2 border rounded" style="border-color:var(--border-primary); background:var(--bg-main); color:var(--text-primary);">${state.userData[key] || ''}</textarea><div class="flex justify-end gap-3 mt-4"><button id="note-cancel" class="px-4 py-2 border rounded" style="border-color:var(--border-primary);">Cancel</button><button id="note-save" class="px-4 py-2 text-white bg-green-700 rounded border-none">Save</button></div></div>`; document.body.appendChild(modal); modal.onclick = (e) => e.target === modal && modal.remove(); modal.querySelector('#note-cancel').onclick = () => modal.remove(); modal.querySelector('#note-save').onclick = () => { updateState(`userData.${key}`, modal.querySelector('#note-text').value); showToast('‚úÖ ‡¶®‡ßã‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!'); modal.remove(); }; }
        function setupEventHandlers() { const content = document.getElementById('syllabus-content'); content.addEventListener('click', (e) => { const statusBtn = e.target.closest('.task-status-btn'); if (statusBtn) { updateState(`userData.${statusBtn.dataset.key}`, (Number(state.userData[statusBtn.dataset.key] ?? 0) + 1) % 6); return; } const noteBtn = e.target.closest('.note-btn'); if (noteBtn) { openNoteModal(noteBtn.dataset.key, noteBtn.dataset.title); } }); content.addEventListener('toggle', (e) => { if (e.target.tagName === 'DETAILS') state.syllabusOpenState[`${state.activeSubject}-${e.target.textContent.includes('‡ßß‡¶Æ') ? 1 : 2}`] = e.target.open; }, true); }
        function startCountdown() { const target = new Date('2025-12-12T00:00:00+06:00'); const els = { d: document.getElementById('days'), h: document.getElementById('hours'), m: document.getElementById('minutes'), s: document.getElementById('seconds') }; function tick() { const diff = Math.max(0, target - new Date()); const d = Math.floor(diff / 864e5), h = Math.floor((diff % 864e5) / 36e5), m = Math.floor((diff % 36e5) / 6e4), s = Math.floor((diff % 6e4) / 1e3); els.d.textContent = d; els.h.textContent = String(h).padStart(2,'0'); els.m.textContent = String(m).padStart(2,'0'); els.s.textContent = String(s).padStart(2,'0'); } tick(); setInterval(tick, 1000); }
        function renderAll() { renderSubjectSelector(); renderSyllabusContent(); renderSubjectsSummary(); renderSummaryBars(); }
        function setupThemeToggle() { const toggleBtn = document.getElementById('theme-toggle'); const savedTheme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', savedTheme); toggleBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô'; toggleBtn.addEventListener('click', () => { const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); toggleBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô'; }); }
        function updateConnectionStatus() { const statusEl = document.getElementById('connection-status'); statusEl.textContent = navigator.onLine ? 'Online' : 'Offline'; statusEl.className = navigator.onLine ? 'online' : 'offline'; if (navigator.onLine) syncPendingWrites(); }
        async function startApp() { syncStatusEl.textContent = 'Initializing...'; await openDB(); try { const cachedData = await getFromDB('userData', 'main'); if (cachedData) { state.userData = cachedData.value; syncStatusEl.textContent = 'Loaded from cache.'; renderAll(); } } catch (e) { console.error("Could not load from cache", e); } onSnapshot(userDocRef, (snap) => { if (snap.exists()) { const firestoreData = snap.data(); state.userData = { ...state.userData, ...firestoreData }; writeToDB('userData', { id: 'main', value: state.userData }); syncStatusEl.textContent = 'Synced with Firebase'; renderAll(); } }, (error) => { console.error("Firestore error:", error); syncStatusEl.textContent = 'Firebase connection failed.'; }); setupEventHandlers(); startCountdown(); setupThemeToggle(); window.addEventListener('online', updateConnectionStatus); window.addEventListener('offline', updateConnectionStatus); updateConnectionStatus(); }
        startApp();
    </script>
</body>
</html>


